# Wix Inventory Sync Guide

## Overview

OMEN now uses a new `wix_inventory_live` table as the **single source of truth** for inventory data.

This table is populated via manual CSV export from Wix → Make.com → OMEN.

## Data Flow

```
Wix Admin → Export CSV → Make.com → POST /sync/wix-inventory → Supabase wix_inventory_live
                                                                        ↓
                                                                     OMEN reads
```

## Step 1: Create the Supabase Table

Run the migration in Supabase SQL Editor:

```sql
-- Run this in Supabase SQL Editor
-- File: migrations/003_wix_inventory_live.sql

DROP TABLE IF EXISTS wix_inventory_live;

CREATE TABLE wix_inventory_live (
  sku TEXT PRIMARY KEY,
  product_id TEXT NOT NULL,
  product_name TEXT NOT NULL,
  variant_name TEXT NOT NULL,
  category TEXT,
  retail DECIMAL(10,2),
  compare_at DECIMAL(10,2),
  cost DECIMAL(10,2),
  quantity_on_hand INTEGER NOT NULL DEFAULT 0,
  inventory_status TEXT,
  visible BOOLEAN DEFAULT true,
  synced_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  source TEXT NOT NULL DEFAULT 'wix_csv'
);

CREATE INDEX idx_wix_inventory_product_id ON wix_inventory_live(product_id);
CREATE INDEX idx_wix_inventory_product_name ON wix_inventory_live(product_name);
CREATE INDEX idx_wix_inventory_quantity ON wix_inventory_live(quantity_on_hand);
```

## Step 2: Export CSV from Wix

1. Go to **Wix Dashboard → Store Products → Products**
2. Click **More Actions → Export**
3. Select **All Products**
4. Download the CSV file

The CSV will contain:
- PRODUCT rows (product info)
- VARIANT rows (inventory + pricing)
- MEDIA rows (images, ignored)

## Step 3: Create Make.com Scenario

### Scenario Name: `SYNC_WIX_INVENTORY`

### Module 1: Trigger
- **Type**: Webhook
- **Name**: "Wix Inventory Sync Trigger"
- **Method**: POST
- **URL**: Will be auto-generated by Make.com

### Module 2: HTTP Request
- **Type**: HTTP → Make a request
- **URL**: `https://omen-agent-production.up.railway.app/sync/wix-inventory`
- **Method**: POST
- **Headers**:
  ```
  Content-Type: application/json
  ```
- **Body Type**: Raw
- **Content Type**: JSON
- **Request content**:
  ```json
  {
    "csvContent": "{{1.csvContent}}"
  }
  ```

### Alternative: Upload CSV File

If you want to upload the CSV file directly:

1. Use **Google Drive** or **Dropbox** module to read the file
2. Use **Tools → Set Variable** to store the file content
3. Send to OMEN endpoint

## Step 4: Run the Sync

### Option A: Via Make.com
1. Trigger your Make.com scenario
2. Pass the CSV content in the webhook payload

### Option B: Via cURL (Testing)

```bash
# Read CSV file and send to OMEN
curl -X POST https://omen-agent-production.up.railway.app/sync/wix-inventory \
  -H "Content-Type: application/json" \
  -d "{\"csvContent\": \"$(cat catalog_products.csv | jq -Rs .)\"}"
```

### Option C: Via Node.js Script

```javascript
const fs = require('fs');
const fetch = require('node-fetch');

const csvContent = fs.readFileSync('catalog_products.csv', 'utf-8');

const response = await fetch('https://omen-agent-production.up.railway.app/sync/wix-inventory', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ csvContent })
});

const result = await response.json();
console.log(result);
```

## Step 5: Verify the Sync

### Check Supabase

```sql
-- Count items in wix_inventory_live
SELECT COUNT(*) FROM wix_inventory_live;

-- View sample data
SELECT sku, product_name, variant_name, quantity_on_hand, retail
FROM wix_inventory_live
LIMIT 10;

-- Check for IN_STOCK items (unknown quantity)
SELECT * FROM wix_inventory_live
WHERE inventory_status = 'IN_STOCK';
```

### Check OMEN Response

The sync endpoint returns:

```json
{
  "ok": true,
  "message": "Successfully synced 339 inventory items from Wix",
  "stats": {
    "productRows": 80,
    "variantRows": 339,
    "itemsInserted": 339,
    "inStockVariants": 45,
    "countedVariants": 294
  },
  "syncedAt": "2026-01-31T12:00:00.000Z"
}
```

## SKU Generation

Since Wix doesn't provide SKUs for variants, OMEN generates deterministic SKUs:

**Formula**: `PRODUCTNAME_VARIANT`

**Examples**:
- Bloopiez + 3.5g → `BLOOPIEZ_3.5G`
- Zoap + 7g → `ZOAP_7G`
- Mai Tai + 28g → `MAITAI_28G`

This ensures consistent SKU matching across syncs.

## Handling IN_STOCK Items

Some Wix variants show "IN_STOCK" instead of a numeric quantity.

OMEN handles this by:
1. Setting `quantity_on_hand = 0`
2. Setting `inventory_status = 'IN_STOCK'`
3. Flagging these items in reports

To fix, update these items in Wix with actual counts.

## Troubleshooting

### "No valid items parsed"
- Ensure CSV has correct columns (handle, fieldType, name, price, inventory, etc.)
- Check for BOM character at start of file

### "Failed to clear existing inventory"
- Run the migration to create `wix_inventory_live` table
- Check Supabase connection

### "VARIANT has no parent PRODUCT"
- CSV may be malformed
- Check that PRODUCT rows come before their VARIANT rows

### Item counts don't match
- MEDIA rows are ignored
- Only VARIANT rows with valid parent PRODUCT are imported
- Check parse errors in response

## Full Replace Behavior

Each sync:
1. **DELETES** all existing rows in `wix_inventory_live`
2. **INSERTS** all items from the new CSV

This ensures no stale data accumulates.

## Fallback Behavior

If `wix_inventory_live` doesn't exist, OMEN falls back to `inventory_live`.

Once you run the migration and first sync, OMEN will use the new table.
