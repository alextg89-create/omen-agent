<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OMEN Admin - Weekly Snapshot</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h1 {
      margin-bottom: 10px;
    }

    .nav {
      margin-bottom: 30px;
    }

    .nav a {
      margin-right: 15px;
      text-decoration: none;
      color: #0066cc;
    }

    h2 {
      margin-top: 30px;
      margin-bottom: 15px;
    }

    .description {
      color: #666;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    input[type="email"],
    input[type="date"],
    select {
      width: 100%;
      max-width: 400px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: #0066cc;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #0052a3;
    }

    .btn-secondary {
      background: #28a745;
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #218838;
    }

    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
      display: none;
    }

    .status.show {
      display: block;
    }

    .status.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .status.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .status.loading {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }

    .snapshot-preview {
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 4px;
      border: 1px solid #dee2e6;
      display: none;
    }

    .snapshot-preview.show {
      display: block;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .metric-card {
      padding: 15px;
      background: white;
      border-radius: 4px;
      border: 1px solid #dee2e6;
    }

    .metric-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 5px;
    }

    .metric-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }

    .recommendations {
      margin-top: 20px;
    }

    .recommendation-section {
      margin-bottom: 20px;
    }

    .recommendation-section h4 {
      margin-bottom: 10px;
      color: #333;
    }

    .recommendation-item {
      padding: 10px;
      background: white;
      border-left: 3px solid #0066cc;
      margin-bottom: 10px;
      border-radius: 2px;
    }

    .recommendation-item strong {
      color: #333;
    }

    .recommendation-item small {
      color: #666;
      display: block;
      margin-top: 5px;
    }

    .help-text {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    .scheduled-info {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 15px;
      border-radius: 4px;
      margin-top: 20px;
    }

    .date-controls {
      display: flex;
      gap: 15px;
      align-items: end;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>OMEN Admin</h1>

    <div class="nav">
      <a href="#" onclick="showSection('chat'); return false;">Chat</a>
      <a href="#" onclick="showSection('snapshot'); return false;">Weekly Snapshot</a>
    </div>

    <!-- CHAT SECTION -->
    <div id="chatSection" class="section" style="display: none;">
      <h2 id="chat">Chat with OMEN</h2>
      <p class="description">Ask OMEN about your inventory, recommendations, or business metrics.</p>

      <div id="chatMessages" style="background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; padding: 15px; height: 400px; overflow-y: auto; margin-bottom: 15px;">
        <div style="color: #666; text-align: center; margin-top: 170px;">Start a conversation with OMEN...</div>
      </div>

      <div style="display: flex; gap: 10px;">
        <input type="text" id="chatInput" placeholder="Ask OMEN anything about your inventory..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" onkeypress="if(event.key==='Enter') sendChatMessage()">
        <button onclick="sendChatMessage()" class="btn-primary">Send</button>
      </div>

      <p class="help-text" style="margin-top: 10px;">
        Try asking: "What should I promote this week?" or "Show me low stock items" or "What's my highest margin product?"
      </p>
    </div>

    <!-- SNAPSHOT SECTION -->
    <div id="snapshotSection" class="section">
      <h2 id="weekly-snapshot">Weekly Operations Snapshot</h2>
      <p class="description">Automated weekly intelligence generated by OMEN.</p>

    <!-- FORM SECTION -->
    <div class="form-group">
      <label for="emailInput">Client Email Address</label>
      <input type="email" id="emailInput" placeholder="user@example.com" value="alexfriedman89@gmail.com">
    </div>

    <div class="date-controls">
      <div class="form-group" style="flex: 1;">
        <label for="dateInput">Snapshot Date (Optional)</label>
        <input type="date" id="dateInput" max="">
        <div class="help-text">Leave empty for current snapshot. Select a past date for historical snapshot.</div>
      </div>

      <div class="form-group" style="flex: 1;">
        <label for="timeframeInput">Timeframe</label>
        <select id="timeframeInput">
          <option value="weekly">Weekly</option>
          <option value="daily">Daily</option>
        </select>
      </div>
    </div>

    <div class="checkbox-group">
      <input type="checkbox" id="useHistoricalMode">
      <label for="useHistoricalMode" style="margin: 0;">Enable Historical Mode (use selected date)</label>
    </div>

    <div class="button-group">
      <button id="generateBtn" class="btn-primary">Generate Snapshot</button>
      <button id="sendBtn" class="btn-secondary" disabled>Send Snapshot Now</button>
    </div>

    <p class="help-text">Generate creates a preview. Send delivers the snapshot to the provided email address.</p>

    <!-- STATUS MESSAGE -->
    <div id="statusMessage" class="status"></div>

    <!-- SNAPSHOT PREVIEW -->
    <div id="snapshotPreview" class="snapshot-preview">
      <h3>Snapshot Preview</h3>
      <div id="snapshotContent"></div>
    </div>

      <!-- SCHEDULED SNAPSHOTS -->
      <h2>Scheduled Snapshots</h2>
      <div class="scheduled-info">
        <strong>Last run:</strong> <span id="lastRun">Not configured</span><br>
        <strong>Next run:</strong> <span id="nextRun">Configure cron job in Railway</span><br>
        <p style="margin-top: 10px; font-size: 14px;">Scheduled jobs run automatically via Railway cron. Manual triggers coming soon.</p>
      </div>
    </div>
    <!-- End Snapshot Section -->

  </div>

  <script>
    // ============================================================================
    // CONFIGURATION
    // ============================================================================

    // Use same domain for API calls (single-domain deployment)
    const BACKEND_URL = window.location.origin;

    // ============================================================================
    // STATE MANAGEMENT
    // ============================================================================

    let currentSnapshot = null;
    let isGenerating = false;
    let isSending = false;

    // ============================================================================
    // DOM ELEMENTS
    // ============================================================================

    const emailInput = document.getElementById('emailInput');
    const dateInput = document.getElementById('dateInput');
    const timeframeInput = document.getElementById('timeframeInput');
    const useHistoricalMode = document.getElementById('useHistoricalMode');
    const generateBtn = document.getElementById('generateBtn');
    const sendBtn = document.getElementById('sendBtn');
    const statusMessage = document.getElementById('statusMessage');
    const snapshotPreview = document.getElementById('snapshotPreview');
    const snapshotContent = document.getElementById('snapshotContent');
    const runScheduledBtn = document.getElementById('runScheduledBtn');

    // ============================================================================
    // INITIALIZATION
    // ============================================================================

    // Set max date to today
    const today = new Date().toISOString().split('T')[0];
    dateInput.max = today;

    // Disable date input by default
    dateInput.disabled = true;
    timeframeInput.disabled = true;

    // Toggle historical mode
    useHistoricalMode.addEventListener('change', (e) => {
      dateInput.disabled = !e.target.checked;
      timeframeInput.disabled = !e.target.checked;

      if (!e.target.checked) {
        dateInput.value = '';
      }
    });

    // AUTO-FETCH: Load latest snapshot on page load (fallback only)
    let hasUserGeneratedSnapshot = false;

    async function loadLatestSnapshot() {
      // Skip if user already generated a snapshot this session
      if (hasUserGeneratedSnapshot) {
        console.log('[UI] Skipping auto-load - user already generated snapshot');
        return;
      }

      try {
        showStatus('Loading latest snapshot...', 'loading');
        const response = await fetch(`${BACKEND_URL}/snapshot/history/last/1`);
        const data = await response.json();

        console.log('[UI] Raw snapshot response:', JSON.stringify(data, null, 2));

        // Double-check user hasn't generated in the meantime
        if (hasUserGeneratedSnapshot) {
          console.log('[UI] Skipping display - user generated snapshot during fetch');
          return;
        }

        if (data.ok && data.snapshots && data.snapshots.length > 0) {
          const latest = data.snapshots[0];
          currentSnapshot = latest.snapshot;
          displaySnapshot(latest.snapshot, true);
          showStatus('Latest snapshot loaded from history', 'success');
        } else {
          showStatus('No existing snapshots. Click "Generate Snapshot" to create one.', 'loading');
        }
      } catch (err) {
        console.error('[UI] Failed to load latest snapshot:', err);
        showStatus('Click "Generate Snapshot" to create a new snapshot.', 'loading');
      }
    }

    // Load on page init
    loadLatestSnapshot();

    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================

    function showStatus(message, type = 'loading') {
      statusMessage.textContent = message;
      statusMessage.className = `status show ${type}`;
    }

    function hideStatus() {
      statusMessage.className = 'status';
    }

    function disableButtons(generating = false, sending = false) {
      generateBtn.disabled = generating;
      sendBtn.disabled = sending || !currentSnapshot;
      isGenerating = generating;
      isSending = sending;
    }

    function formatCurrency(value) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
      }).format(value);
    }

    function formatPercent(value) {
      return `${value.toFixed(2)}%`;
    }

    // ============================================================================
    // SNAPSHOT GENERATION
    // ============================================================================

    async function generateSnapshot() {
      try {
        // Prevent concurrent requests
        if (isGenerating) {
          showStatus('Generation already in progress...', 'loading');
          return;
        }

        disableButtons(true, false);
        showStatus('Generating snapshot...', 'loading');
        snapshotPreview.classList.remove('show');

        // Build request body
        const requestBody = {
          timeframe: timeframeInput.value
        };

        // Only include asOfDate if historical mode is enabled and date is selected
        if (useHistoricalMode.checked && dateInput.value) {
          requestBody.asOfDate = dateInput.value;
        }

        console.log('Generating snapshot with params:', requestBody);

        const response = await fetch(`${BACKEND_URL}/snapshot/generate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestBody)
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || data.message || 'Failed to generate snapshot');
        }

        if (data.ok) {
          // Mark that user generated - prevents auto-load from overwriting
          hasUserGeneratedSnapshot = true;
          currentSnapshot = data.snapshot;

          console.log('[UI] Generate response snapshot:', JSON.stringify(data.snapshot, null, 2));

          // Calculate age and recommendations
          const totalRecs = (data.snapshot.recommendations?.promotions?.length || 0) +
                           (data.snapshot.recommendations?.pricing?.length || 0) +
                           (data.snapshot.recommendations?.inventory?.length || 0);

          const now = new Date();
          const generated = new Date(data.snapshot.generatedAt);
          const ageMinutes = Math.floor((now - generated) / 1000 / 60);

          // Debug logging
          console.log('Snapshot loaded:', {
            generatedAt: data.snapshot.generatedAt,
            ageMinutes: ageMinutes,
            fromCache: data.fromCache,
            totalRecommendations: totalRecs,
            promotions: data.snapshot.recommendations?.promotions?.length || 0,
            pricing: data.snapshot.recommendations?.pricing?.length || 0,
            inventory: data.snapshot.recommendations?.inventory?.length || 0
          });

          displaySnapshot(data.snapshot, data.fromCache);

          // Staleness-aware status message
          let statusMsg = 'Snapshot loaded successfully';
          if (ageMinutes < 5) {
            statusMsg = 'Fresh snapshot generated successfully';
          } else if (ageMinutes < 60) {
            statusMsg = `Snapshot loaded (${ageMinutes} minutes old)`;
          } else if (ageMinutes < 1440) {
            statusMsg = `Snapshot loaded (${Math.floor(ageMinutes / 60)} hours old)`;
          } else {
            statusMsg = `‚ö†Ô∏è Stale snapshot loaded (${Math.floor(ageMinutes / 1440)} days old)`;
          }

          const recStatus = totalRecs > 0 ? ` - ${totalRecs} action${totalRecs > 1 ? 's' : ''} identified` : ' - no actions needed';
          showStatus(`${statusMsg}${recStatus}`, ageMinutes > 60 ? 'error' : 'success');
          disableButtons(false, false);
        } else {
          throw new Error(data.error || 'Unknown error');
        }
      } catch (error) {
        console.error('Snapshot generation error:', error);
        showStatus(`Error: ${error.message}`, 'error');
        disableButtons(false, false);
        currentSnapshot = null;
      }
    }

    // ============================================================================
    // SNAPSHOT DISPLAY
    // ============================================================================

    function displaySnapshot(snapshot, fromCache = false) {
      const { metrics, recommendations, asOfDate, timeframe, generatedAt, velocity } = snapshot;

      // STALENESS DETECTION based on generatedAt timestamp
      const now = new Date();
      const generated = new Date(generatedAt);
      const ageMinutes = Math.floor((now - generated) / 1000 / 60);
      const ageHours = Math.floor(ageMinutes / 60);
      const ageDays = Math.floor(ageHours / 24);

      // Determine freshness
      let freshness, freshnessColor, freshnessBg, freshnessLabel, showWarning;

      if (ageMinutes < 5) {
        freshness = 'fresh';
        freshnessColor = '#28a745';
        freshnessBg = '#d4edda';
        freshnessLabel = 'Fresh (just generated)';
        showWarning = false;
      } else if (ageHours < 1) {
        freshness = 'recent';
        freshnessColor = '#28a745';
        freshnessBg = '#d4edda';
        freshnessLabel = `Fresh (${ageMinutes} minutes old)`;
        showWarning = false;
      } else if (ageHours < 24) {
        freshness = 'aging';
        freshnessColor = '#ff9800';
        freshnessBg = '#fff3cd';
        freshnessLabel = `Aging (${ageHours} hour${ageHours > 1 ? 's' : ''} old)`;
        showWarning = true;
      } else {
        freshness = 'stale';
        freshnessColor = '#dc3545';
        freshnessBg = '#f8d7da';
        freshnessLabel = `Stale (${ageDays} day${ageDays > 1 ? 's' : ''} old)`;
        showWarning = true;
      }

      const dateInfo = asOfDate ? ` - ${new Date(asOfDate + 'T00:00:00Z').toLocaleDateString()}` : '';
      const generatedInfo = generatedAt ? ` on ${generated.toLocaleString()}` : '';

      const refreshButton = showWarning ? `<button onclick="generateSnapshot()" style="margin-left: 10px; padding: 5px 10px; font-size: 12px; cursor: pointer; background: #0066cc; color: white; border: none; border-radius: 4px;">Refresh Now</button>` : '';

      let html = `
        <div style="margin-bottom: 20px; padding: 10px; background: ${freshnessBg}; border-radius: 4px; border: 1px solid ${freshnessColor};">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>Timeframe:</strong> ${timeframe.charAt(0).toUpperCase() + timeframe.slice(1)}${dateInfo}
            </div>
            <div>
              <span style="color: ${freshnessColor}; font-weight: 500;">${freshnessLabel}</span>
              ${refreshButton}
            </div>
          </div>
          <div style="margin-top: 5px; font-size: 12px; color: #666;">
            Generated${generatedInfo}
          </div>
          ${showWarning ? '<div style="margin-top: 8px; font-size: 13px; color: #856404;">‚ö†Ô∏è This snapshot may not reflect current inventory. Click "Refresh Now" to get latest data.</div>' : ''}
        </div>

        <h4>Financial Metrics</h4>
        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-label">Total Items</div>
            <div class="metric-value">${metrics.totalItems}</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Avg Margin</div>
            <div class="metric-value">${formatPercent(metrics.averageMargin)}</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Potential Revenue</div>
            <div class="metric-value">${formatCurrency(metrics.totalRevenue)}</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Potential Profit</div>
            <div class="metric-value">${formatCurrency(metrics.totalProfit)}</div>
          </div>
        </div>

        ${velocity ? `
        <h4>Sales Activity (${timeframe})</h4>
        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-label">Orders</div>
            <div class="metric-value">${velocity.orderCount || 0}</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Unique SKUs Sold</div>
            <div class="metric-value">${velocity.uniqueSKUs || 0}</div>
          </div>
        </div>
        ` : ''}
      `;

      // Recommendations
      html += '<div class="recommendations">';
      html += '<h4>Recommendations</h4>';

      if (recommendations.promotions.length > 0) {
        html += `
          <div class="recommendation-section">
            <h4>üéØ Promotion Opportunities (${recommendations.promotions.length})</h4>
            ${recommendations.promotions.slice(0, 5).map(rec => `
              <div class="recommendation-item">
                <strong>${rec.name}</strong>: ${rec.reason}
                <small>Action: ${rec.action} | Margin: ${formatPercent(rec.triggeringMetrics.margin)} | Stock: ${rec.triggeringMetrics.quantity} | Confidence: ${(rec.confidence * 100).toFixed(0)}%</small>
              </div>
            `).join('')}
          </div>
        `;
      }

      if (recommendations.pricing.length > 0) {
        html += `
          <div class="recommendation-section">
            <h4>üí∞ Pricing Actions (${recommendations.pricing.length})</h4>
            ${recommendations.pricing.slice(0, 5).map(rec => `
              <div class="recommendation-item">
                <strong>${rec.name}</strong>: ${rec.reason}
                <small>Action: ${rec.action} | Current Margin: ${formatPercent(rec.triggeringMetrics.margin)} | Confidence: ${(rec.confidence * 100).toFixed(0)}%</small>
              </div>
            `).join('')}
          </div>
        `;
      }

      if (recommendations.inventory.length > 0) {
        html += `
          <div class="recommendation-section">
            <h4>üì¶ Inventory Actions (${recommendations.inventory.length})</h4>
            ${recommendations.inventory.slice(0, 5).map(rec => {
              const metrics = rec.triggeringMetrics || {};
              const signalBadge = rec.signalType ? `<span style="background: #ff6b6b; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">${rec.signalType}</span>` : '';
              const priority = rec.priorityScore ? ` | Priority: ${rec.priorityScore}` : '';
              const depletion = metrics.daysUntilDepletion ? ` | ${metrics.daysUntilDepletion} days left` : '';
              const rate = metrics.depletionRate ? ` | ${metrics.depletionRate} units/day` : '';

              return `
              <div class="recommendation-item">
                <strong>${rec.name}</strong> ${signalBadge}: ${rec.reason}
                <small>Action: ${rec.action} | Stock: ${metrics.currentQuantity || metrics.quantity || 0}${depletion}${rate}${priority} | Confidence: ${(rec.confidence * 100).toFixed(0)}%</small>
              </div>
            `}).join('')}
          </div>
        `;
      }

      // Calculate total recommendations
      const totalRecs = (recommendations.promotions?.length || 0) +
                        (recommendations.pricing?.length || 0) +
                        (recommendations.inventory?.length || 0);

      if (totalRecs === 0) {
        html += '<p style="color: #666; padding: 15px; background: #f8f9fa; border-radius: 4px;">No urgent actions identified. Inventory metrics are stable.</p>';
      } else {
        html += `<p style="color: #28a745; font-weight: 500; margin-top: 15px;">‚úì ${totalRecs} action item${totalRecs > 1 ? 's' : ''} identified</p>`;
      }

      html += '</div>';

      snapshotContent.innerHTML = html;
      snapshotPreview.classList.add('show');
    }

    // ============================================================================
    // SEND SNAPSHOT
    // ============================================================================

    async function sendSnapshot() {
      try {
        const email = emailInput.value.trim();

        if (!email) {
          showStatus('Please enter an email address', 'error');
          return;
        }

        if (!currentSnapshot) {
          showStatus('Please generate a snapshot first', 'error');
          return;
        }

        if (isSending) {
          showStatus('Send already in progress...', 'loading');
          return;
        }

        disableButtons(false, true);
        showStatus('Preparing email...', 'loading');

        const response = await fetch(`${BACKEND_URL}/snapshot/send`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || data.message || 'Failed to send snapshot');
        }

        if (data.ok) {
          const dateInfo = data.snapshotDate ? ` for ${data.snapshotDate}` : '';
          showStatus(`Snapshot${dateInfo} prepared for delivery to ${email}!`, 'success');
          console.log('Email prepared:', data.email);
          disableButtons(false, false);
        } else {
          throw new Error(data.error || 'Unknown error');
        }
      } catch (error) {
        console.error('Send error:', error);
        showStatus(`Error: ${error.message}`, 'error');
        disableButtons(false, false);
      }
    }

    // ============================================================================
    // CHAT FUNCTIONALITY
    // ============================================================================

    let conversationHistory = [];

    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();

      if (!message) return;

      // Add user message to UI
      addChatMessage('user', message);
      input.value = '';

      // Show thinking indicator
      const thinkingId = addChatMessage('assistant', 'Thinking...');

      try {
        const response = await fetch(`${BACKEND_URL}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message,
            conversationHistory
          })
        });

        const data = await response.json();

        // Remove thinking indicator
        document.getElementById(thinkingId).remove();

        if (data.response) {
          // Add OMEN's response
          addChatMessage('assistant', data.response);

          // Update conversation history
          conversationHistory.push(
            { role: 'user', content: message },
            { role: 'assistant', content: data.response }
          );

          // Keep only last 10 messages to avoid token limits
          if (conversationHistory.length > 20) {
            conversationHistory = conversationHistory.slice(-20);
          }
        } else {
          addChatMessage('assistant', 'Sorry, I encountered an error. Please try again.');
        }
      } catch (error) {
        document.getElementById(thinkingId).remove();
        addChatMessage('assistant', `Error: ${error.message}`);
      }
    }

    function addChatMessage(role, content) {
      const messagesDiv = document.getElementById('chatMessages');
      const messageId = 'msg-' + Date.now();

      // Remove placeholder if exists
      if (messagesDiv.querySelector('[style*="Start a conversation"]')) {
        messagesDiv.innerHTML = '';
      }

      const messageDiv = document.createElement('div');
      messageDiv.id = messageId;
      messageDiv.style.cssText = `
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 8px;
        ${role === 'user' ?
          'background: #007bff; color: white; margin-left: 60px; text-align: right;' :
          'background: #e9ecef; color: #333; margin-right: 60px;'
        }
      `;

      const roleLabel = document.createElement('div');
      roleLabel.style.cssText = 'font-size: 11px; font-weight: bold; margin-bottom: 5px; opacity: 0.8;';
      roleLabel.textContent = role === 'user' ? 'YOU' : 'OMEN';

      const contentDiv = document.createElement('div');
      contentDiv.style.cssText = 'white-space: pre-wrap; line-height: 1.5;';
      contentDiv.textContent = content;

      messageDiv.appendChild(roleLabel);
      messageDiv.appendChild(contentDiv);
      messagesDiv.appendChild(messageDiv);

      // Scroll to bottom
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      return messageId;
    }

    // ============================================================================
    // SECTION SWITCHING
    // ============================================================================

    function showSection(section) {
      const chatSection = document.getElementById('chatSection');
      const snapshotSection = document.getElementById('snapshotSection');

      if (section === 'chat') {
        chatSection.style.display = 'block';
        snapshotSection.style.display = 'none';
      } else {
        chatSection.style.display = 'none';
        snapshotSection.style.display = 'block';
      }
    }

    // ============================================================================
    // EVENT LISTENERS
    // ============================================================================

    generateBtn.addEventListener('click', generateSnapshot);
    sendBtn.addEventListener('click', sendSnapshot);

    // Show snapshot section by default
    showSection('snapshot');

    // ============================================================================
    // INITIAL LOAD
    // ============================================================================

    console.log('OMEN Admin UI initialized');
    console.log('Backend URL:', BACKEND_URL);
  </script>
</body>
</html>
