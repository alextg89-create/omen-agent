<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OMEN Vault</title>
  <!-- Supabase JS Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Auth config from env vars -->
  <script src="/auth-config.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: #1a1a1a;
      color: #e0e0e0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #242424;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }

    h1 {
      margin-bottom: 10px;
      color: #fff;
    }

    .nav {
      margin-bottom: 30px;
      border-bottom: 1px solid #333;
      padding-bottom: 15px;
    }

    .nav a {
      margin-right: 20px;
      text-decoration: none;
      color: #888;
      font-weight: 500;
      padding: 8px 0;
      transition: color 0.2s;
    }

    .nav a:hover, .nav a.active {
      color: #fff;
    }

    h2 {
      margin-top: 30px;
      margin-bottom: 15px;
      color: #fff;
    }

    .description {
      color: #888;
      margin-bottom: 20px;
    }

    /* CONFIDENCE STRIP - TRUTH RENDERING */
    .confidence-strip {
      padding: 12px 16px;
      border-radius: 4px;
      margin-bottom: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .confidence-high {
      background: rgba(40, 167, 69, 0.15);
      border: 1px solid #28a745;
      color: #28a745;
    }

    .confidence-medium {
      background: rgba(255, 152, 0, 0.15);
      border: 1px solid #ff9800;
      color: #ff9800;
    }

    .confidence-low {
      background: rgba(220, 53, 69, 0.15);
      border: 1px solid #dc3545;
      color: #dc3545;
    }

    .confidence-unknown {
      background: rgba(108, 117, 125, 0.15);
      border: 1px solid #6c757d;
      color: #6c757d;
    }

    /* WARNINGS PANEL - NON-DISMISSIBLE, ABOVE RESPONSE */
    .warnings-panel {
      background: rgba(220, 53, 69, 0.1);
      border: 1px solid #dc3545;
      border-radius: 4px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .warnings-panel h4 {
      color: #dc3545;
      margin-bottom: 10px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .warnings-panel ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .warnings-panel li {
      color: #ff6b6b;
      padding: 6px 0;
      border-bottom: 1px solid rgba(220, 53, 69, 0.2);
      font-size: 14px;
    }

    .warnings-panel li:last-child {
      border-bottom: none;
    }

    /* DATA FRESHNESS INDICATOR */
    .freshness-indicator {
      font-size: 12px;
      color: #888;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .freshness-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .freshness-fresh { background: #28a745; }
    .freshness-aging { background: #ff9800; }
    .freshness-stale { background: #dc3545; }
    .freshness-unknown { background: #6c757d; }

    /* REFUSAL STATE */
    .refusal-state {
      background: rgba(220, 53, 69, 0.1);
      border: 2px solid #dc3545;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      margin: 20px 0;
    }

    .refusal-state h3 {
      color: #dc3545;
      margin-bottom: 15px;
    }

    .refusal-state p {
      color: #888;
      max-width: 500px;
      margin: 0 auto;
    }

    /* FORM ELEMENTS */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #ccc;
    }

    input[type="email"],
    input[type="date"],
    input[type="text"],
    select {
      width: 100%;
      max-width: 400px;
      padding: 10px;
      border: 1px solid #444;
      border-radius: 4px;
      font-size: 14px;
      background: #1a1a1a;
      color: #e0e0e0;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #0066cc;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: #0066cc;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #0052a3;
    }

    .btn-secondary {
      background: #28a745;
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #218838;
    }

    /* STATUS MESSAGE */
    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
      display: none;
    }

    .status.show {
      display: block;
    }

    .status.success {
      background: rgba(40, 167, 69, 0.15);
      border: 1px solid #28a745;
      color: #28a745;
    }

    .status.error {
      background: rgba(220, 53, 69, 0.15);
      border: 1px solid #dc3545;
      color: #dc3545;
    }

    .status.loading {
      background: rgba(0, 102, 204, 0.15);
      border: 1px solid #0066cc;
      color: #6db3f2;
    }

    /* SNAPSHOT PREVIEW */
    .snapshot-preview {
      margin-top: 30px;
      padding: 20px;
      background: #1a1a1a;
      border-radius: 4px;
      border: 1px solid #333;
      display: none;
    }

    .snapshot-preview.show {
      display: block;
    }

    /* METRICS GRID */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .metric-card {
      padding: 15px;
      background: #242424;
      border-radius: 4px;
      border: 1px solid #333;
    }

    .metric-label {
      font-size: 11px;
      color: #888;
      text-transform: uppercase;
      margin-bottom: 5px;
      letter-spacing: 0.5px;
    }

    .metric-value {
      font-size: 24px;
      font-weight: bold;
      color: #fff;
    }

    .metric-value.zero {
      color: #ff9800;
    }

    .metric-value.null {
      color: #dc3545;
    }

    /* RECOMMENDATIONS */
    .recommendations {
      margin-top: 20px;
    }

    .recommendation-section {
      margin-bottom: 20px;
    }

    .recommendation-section h4 {
      margin-bottom: 10px;
      color: #ccc;
    }

    .recommendation-item {
      padding: 12px;
      background: #1a1a1a;
      border-left: 3px solid #0066cc;
      margin-bottom: 10px;
      border-radius: 2px;
    }

    .recommendation-item strong {
      color: #fff;
    }

    .recommendation-item small {
      color: #888;
      display: block;
      margin-top: 5px;
    }

    .help-text {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    /* CHAT */
    #chatMessages {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 15px;
      height: 400px;
      overflow-y: auto;
      margin-bottom: 15px;
    }

    .chat-message {
      margin-bottom: 15px;
      padding: 10px 15px;
      border-radius: 8px;
    }

    .chat-message.user {
      background: #0066cc;
      color: white;
      margin-left: 60px;
      text-align: right;
    }

    .chat-message.assistant {
      background: #333;
      color: #e0e0e0;
      margin-right: 60px;
    }

    .chat-role {
      font-size: 11px;
      font-weight: bold;
      margin-bottom: 5px;
      opacity: 0.8;
    }

    .chat-content {
      white-space: pre-wrap;
      line-height: 1.5;
    }

    .chat-meta {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(255,255,255,0.1);
      font-size: 11px;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>OMEN Vault</h1>
    <p class="description">Operations Intelligence. Truth only.</p>

    <div class="nav" style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <a href="#" onclick="showSection('chat'); return false;" id="navChat">Chat</a>
        <a href="#" onclick="showSection('snapshot'); return false;" id="navSnapshot" class="active">Snapshot</a>
      </div>
      <button onclick="handleLogout()" style="background: transparent; border: 1px solid #444; color: #888; padding: 6px 12px; font-size: 12px;">Logout</button>
    </div>

    <!-- CHAT SECTION -->
    <div id="chatSection" class="section">
      <h2>Ask OMEN</h2>

      <!-- CHAT WARNINGS (rendered above response) -->
      <div id="chatWarnings" class="warnings-panel" style="display: none;">
        <h4>Warnings</h4>
        <ul id="chatWarningsList"></ul>
      </div>

      <!-- CHAT CONFIDENCE STRIP -->
      <div id="chatConfidence" class="confidence-strip confidence-unknown" style="display: none;">
        <span id="chatConfidenceLabel">Unknown</span>
        <span class="freshness-indicator">
          <span id="chatFreshnessDot" class="freshness-dot freshness-unknown"></span>
          <span id="chatFreshnessText">No data</span>
        </span>
      </div>

      <div id="chatMessages">
        <div style="color: #666; text-align: center; margin-top: 170px;">Ask OMEN about your inventory...</div>
      </div>

      <div style="display: flex; gap: 10px;">
        <input type="text" id="chatInput" placeholder="What should I promote this week?" onkeypress="if(event.key==='Enter') sendChatMessage()">
        <button onclick="sendChatMessage()" class="btn-primary">Send</button>
      </div>
    </div>

    <!-- SNAPSHOT SECTION -->
    <div id="snapshotSection" class="section active">
      <h2>Operations Snapshot</h2>

      <!-- SNAPSHOT WARNINGS (rendered above everything) -->
      <div id="snapshotWarnings" class="warnings-panel" style="display: none;">
        <h4>Warnings</h4>
        <ul id="snapshotWarningsList"></ul>
      </div>

      <!-- SNAPSHOT CONFIDENCE STRIP -->
      <div id="snapshotConfidence" class="confidence-strip confidence-unknown" style="display: none;">
        <span id="snapshotConfidenceLabel">Unknown</span>
        <span class="freshness-indicator">
          <span id="snapshotFreshnessDot" class="freshness-dot freshness-unknown"></span>
          <span id="snapshotFreshnessText">No data</span>
        </span>
      </div>

      <div class="form-group">
        <label for="timeframeInput">Timeframe</label>
        <select id="timeframeInput" onchange="handleTimeframeChange()">
          <option value="weekly">Weekly</option>
          <option value="daily">Daily</option>
          <option value="monthly">Monthly</option>
          <option value="custom">Custom Range</option>
        </select>
      </div>

      <!-- Custom Date Range (shown when custom is selected) -->
      <div id="customDateRange" class="form-group" style="display: none;">
        <div style="display: flex; gap: 10px; align-items: center;">
          <div>
            <label for="startDateInput">Start Date</label>
            <input type="date" id="startDateInput" style="background: #2a2a3e; border: 1px solid #3a3a5e; color: #fff; padding: 8px; border-radius: 4px;">
          </div>
          <div>
            <label for="endDateInput">End Date</label>
            <input type="date" id="endDateInput" style="background: #2a2a3e; border: 1px solid #3a3a5e; color: #fff; padding: 8px; border-radius: 4px;">
          </div>
        </div>
      </div>

      <div class="button-group">
        <button id="generateBtn" class="btn-primary" onclick="generateSnapshot()">Generate Snapshot</button>
      </div>

      <div id="statusMessage" class="status"></div>

      <!-- REFUSAL STATE (shown when authority unavailable) -->
      <div id="refusalState" class="refusal-state" style="display: none;">
        <h3>Cannot Provide Intelligence</h3>
        <p id="refusalMessage">Authority unavailable.</p>
      </div>

      <!-- SNAPSHOT PREVIEW -->
      <div id="snapshotPreview" class="snapshot-preview">
        <div id="snapshotContent"></div>
      </div>
    </div>
  </div>

  <script>
    // ============================================================================
    // AUTH GUARD - Redirect to login if not authenticated
    // ============================================================================
    let supabaseAuth = null;

    (async function authGuard() {
      // Hide app until auth is verified
      document.body.style.visibility = 'hidden';

      // Check if Supabase config is available
      if (!window.SUPABASE_CONFIG || !window.SUPABASE_CONFIG.url || !window.SUPABASE_CONFIG.anonKey) {
        console.error('Supabase config not available');
        window.location.href = '/login.html';
        return;
      }

      // Initialize Supabase client
      supabaseAuth = window.supabase.createClient(
        window.SUPABASE_CONFIG.url,
        window.SUPABASE_CONFIG.anonKey
      );

      try {
        const { data: { session } } = await supabaseAuth.auth.getSession();

        if (!session) {
          // Not logged in, redirect to login
          window.location.href = '/login.html';
          return;
        }

        // Logged in, show app
        document.body.style.visibility = 'visible';
      } catch (err) {
        console.error('Auth check failed:', err);
        window.location.href = '/login.html';
      }
    })();

    // Logout handler
    async function handleLogout() {
      if (supabaseAuth) {
        await supabaseAuth.auth.signOut();
      }
      window.location.href = '/login.html';
    }

    // ============================================================================
    // CONFIGURATION
    // ============================================================================
    const BACKEND_URL = window.location.origin;

    // ============================================================================
    // STATE
    // ============================================================================
    let currentSnapshot = null;
    let inventoryLastSyncedAt = null;

    // ============================================================================
    // TRUTH RENDERING UTILITIES
    // ============================================================================

    /**
     * Render confidence strip - VERBATIM from response
     * No defaults. No inference. Truth only.
     */
    function renderConfidence(elementPrefix, confidence, dataFreshness) {
      const strip = document.getElementById(`${elementPrefix}Confidence`);
      const label = document.getElementById(`${elementPrefix}ConfidenceLabel`);
      const dot = document.getElementById(`${elementPrefix}FreshnessDot`);
      const text = document.getElementById(`${elementPrefix}FreshnessText`);

      if (!strip) return;

      // Remove all confidence classes
      strip.classList.remove('confidence-high', 'confidence-medium', 'confidence-low', 'confidence-unknown');
      dot.classList.remove('freshness-fresh', 'freshness-aging', 'freshness-stale', 'freshness-unknown');

      // Render confidence VERBATIM
      if (confidence === 'high') {
        strip.classList.add('confidence-high');
        label.textContent = 'HIGH CONFIDENCE';
      } else if (confidence === 'medium') {
        strip.classList.add('confidence-medium');
        label.textContent = 'MEDIUM CONFIDENCE';
      } else if (confidence === 'low') {
        strip.classList.add('confidence-low');
        label.textContent = 'LOW CONFIDENCE';
      } else {
        strip.classList.add('confidence-unknown');
        label.textContent = 'UNKNOWN';
      }

      // Render freshness
      if (dataFreshness) {
        const status = dataFreshness.status || 'unknown';
        if (status === 'fresh') {
          dot.classList.add('freshness-fresh');
          text.textContent = 'Data fresh';
        } else if (status === 'aging') {
          dot.classList.add('freshness-aging');
          text.textContent = `Synced ${dataFreshness.age_hours || '?'}h ago`;
        } else if (status === 'stale') {
          dot.classList.add('freshness-stale');
          text.textContent = `Stale (${dataFreshness.age_hours || '?'}h ago)`;
        } else {
          dot.classList.add('freshness-unknown');
          text.textContent = 'Sync unknown';
        }
      } else {
        dot.classList.add('freshness-unknown');
        text.textContent = 'No freshness data';
      }

      strip.style.display = 'flex';
    }

    /**
     * Render warnings - ALWAYS VISIBLE, NOT DISMISSIBLE, ABOVE RESPONSE
     */
    function renderWarnings(elementPrefix, warnings) {
      const panel = document.getElementById(`${elementPrefix}Warnings`);
      const list = document.getElementById(`${elementPrefix}WarningsList`);

      if (!panel || !list) return;

      if (!warnings || warnings.length === 0) {
        panel.style.display = 'none';
        return;
      }

      list.innerHTML = '';
      warnings.forEach(warning => {
        const li = document.createElement('li');
        li.textContent = warning;
        list.appendChild(li);
      });

      panel.style.display = 'block';
    }

    /**
     * Render value - ZERO vs NULL distinction
     * Zero = fact (render as "0")
     * Null = absence (render as refusal marker)
     */
    function renderValue(value, format = 'number') {
      // NULL = ABSENCE → Refusal marker
      if (value === null || value === undefined) {
        return '<span class="metric-value null">—</span>';
      }

      // ZERO = FACT → Render as zero
      if (value === 0) {
        if (format === 'currency') {
          return '<span class="metric-value zero">$0.00</span>';
        }
        if (format === 'percent') {
          return '<span class="metric-value zero">0%</span>';
        }
        return '<span class="metric-value zero">0</span>';
      }

      // Valid value → Render normally
      if (format === 'currency') {
        return `<span class="metric-value">${formatCurrency(value)}</span>`;
      }
      if (format === 'percent') {
        return `<span class="metric-value">${formatPercent(value)}</span>`;
      }
      return `<span class="metric-value">${value}</span>`;
    }

    function formatCurrency(value) {
      if (typeof value !== 'number' || isNaN(value)) return '—';
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
      }).format(value);
    }

    function formatPercent(value) {
      if (value === null || value === undefined) return '—';
      if (typeof value !== 'number' || Number.isNaN(value)) return '—';
      return `${value.toFixed(1)}%`;
    }

    /**
     * Validate snapshot freshness against inventory sync
     * Snapshot must be generated AFTER inventory sync
     */
    function validateSnapshotFreshness(snapshot) {
      if (!snapshot) return { valid: false, reason: 'No snapshot' };

      const dataFreshness = snapshot.data_freshness;
      if (!dataFreshness) {
        return { valid: false, reason: 'No freshness data' };
      }

      const syncedAt = dataFreshness.inventory_last_synced_at;
      if (!syncedAt) {
        return { valid: false, reason: 'Inventory never synced' };
      }

      const generatedAt = snapshot.generatedAt;
      if (!generatedAt) {
        return { valid: false, reason: 'Snapshot has no timestamp' };
      }

      const syncTime = new Date(syncedAt);
      const genTime = new Date(generatedAt);

      if (genTime < syncTime) {
        return {
          valid: false,
          reason: `Snapshot generated BEFORE inventory sync. Regenerate snapshot.`
        };
      }

      return { valid: true, reason: null };
    }

    // ============================================================================
    // STATUS
    // ============================================================================

    function showStatus(message, type = 'loading') {
      const el = document.getElementById('statusMessage');
      el.textContent = message;
      el.className = `status show ${type}`;
    }

    function hideStatus() {
      document.getElementById('statusMessage').className = 'status';
    }

    // ============================================================================
    // REFUSAL STATE
    // ============================================================================

    function showRefusal(message) {
      document.getElementById('refusalMessage').textContent = message;
      document.getElementById('refusalState').style.display = 'block';
      document.getElementById('snapshotPreview').classList.remove('show');
    }

    function hideRefusal() {
      document.getElementById('refusalState').style.display = 'none';
    }

    // ============================================================================
    // TIMEFRAME HANDLING
    // ============================================================================

    function handleTimeframeChange() {
      const timeframe = document.getElementById('timeframeInput').value;
      const customDateRange = document.getElementById('customDateRange');

      if (timeframe === 'custom') {
        customDateRange.style.display = 'block';
        // Set default dates (last 7 days)
        const today = new Date();
        const weekAgo = new Date(today);
        weekAgo.setDate(weekAgo.getDate() - 7);

        document.getElementById('endDateInput').value = today.toISOString().split('T')[0];
        document.getElementById('startDateInput').value = weekAgo.toISOString().split('T')[0];
      } else {
        customDateRange.style.display = 'none';
      }
    }

    // ============================================================================
    // SNAPSHOT GENERATION
    // ============================================================================

    async function generateSnapshot() {
      try {
        showStatus('Generating snapshot...', 'loading');
        hideRefusal();
        document.getElementById('snapshotPreview').classList.remove('show');

        const timeframe = document.getElementById('timeframeInput').value;

        // Build request body
        const requestBody = { timeframe };

        // Add custom date range if selected
        if (timeframe === 'custom') {
          const startDate = document.getElementById('startDateInput').value;
          const endDate = document.getElementById('endDateInput').value;

          if (!startDate || !endDate) {
            showStatus('Please select start and end dates', 'error');
            return;
          }

          requestBody.startDate = startDate;
          requestBody.endDate = endDate;
        }

        const response = await fetch(`${BACKEND_URL}/snapshot/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });

        const data = await response.json();

        // AUTHORITY ERROR → Show refusal
        if (!data.ok && data.error === 'authority_unavailable') {
          renderConfidence('snapshot', 'low', null);
          renderWarnings('snapshot', data.warnings || [data.message]);
          showRefusal(data.message);
          showStatus('Authority unavailable', 'error');
          return;
        }

        if (!data.ok) {
          throw new Error(data.error || data.message || 'Generation failed');
        }

        const snapshot = data.snapshot;
        if (!snapshot) {
          throw new Error('No snapshot in response');
        }

        currentSnapshot = snapshot;

        // FRESHNESS VALIDATION
        const freshness = validateSnapshotFreshness(snapshot);
        if (!freshness.valid) {
          renderWarnings('snapshot', [freshness.reason, ...(snapshot.warnings || [])]);
        } else {
          renderWarnings('snapshot', snapshot.warnings || []);
        }

        // Render confidence VERBATIM from response
        renderConfidence('snapshot', snapshot.confidence, snapshot.data_freshness);

        // Display snapshot
        displaySnapshot(snapshot);
        showStatus('Snapshot generated', 'success');

      } catch (error) {
        console.error('Snapshot error:', error);
        showStatus(`Error: ${error.message}`, 'error');
        renderConfidence('snapshot', 'low', null);
        renderWarnings('snapshot', [error.message]);
      }
    }

    // ============================================================================
    // SNAPSHOT DISPLAY
    // ============================================================================

    function displaySnapshot(snapshot) {
      if (!snapshot) {
        showRefusal('No snapshot data');
        return;
      }

      const metrics = snapshot.metrics || {};
      const recommendations = snapshot.recommendations || { promotions: [], pricing: [], inventory: [] };
      const velocity = snapshot.velocity || {};
      const temporal = snapshot.temporal || {};
      const orderContext = snapshot.orderContext || {};

      const hasRealData = temporal.hasRealData === true || velocity.orderCount > 0;
      const timeframeOrders = orderContext.timeframe?.orderCount || velocity.orderCount || 0;
      const last30DaysOrders = orderContext.last30Days?.orderCount || 0;
      const allTimeOrders = orderContext.allTime?.orderCount || 0;

      // Format timeframe label
      const timeframeLabel = snapshot.timeframe?.charAt(0).toUpperCase() + (snapshot.timeframe?.slice(1) || '');
      const dateRangeStr = snapshot.dateRange ?
        `${new Date(snapshot.dateRange.startDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})} - ${new Date(snapshot.dateRange.endDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}` : '';

      // Extract executive intelligence
      const intelligence = snapshot.intelligence || {};
      const executiveDecision = intelligence.executiveDecision || {};
      const executiveSummary = intelligence.executiveSummary || {};
      const wowInsights = intelligence.wowInsights || [];
      const primaryDecision = executiveDecision.primaryDecision;
      const alternatives = executiveDecision.alternatives || [];
      const inactionCost = executiveDecision.inactionCost || {};

      let html = `
        <h3 style="color: #fff; margin-bottom: 5px;">${timeframeLabel} Intelligence Brief</h3>
        ${dateRangeStr ? `<div style="color: #666; margin-bottom: 15px; font-size: 0.85em;">${dateRangeStr}</div>` : ''}
      `;

      // ═══════════════════════════════════════════════════════════════════════
      // THE EXECUTIVE DECISION - Lead with THE call
      // ═══════════════════════════════════════════════════════════════════════
      html += '<div class="executive-decision" style="background: linear-gradient(135deg, #1a2a3a 0%, #0a1a2a 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4CAF50;">';

      if (primaryDecision && primaryDecision.action) {
        // THE DECISION
        html += `
          <div style="font-size: 0.75em; color: #4CAF50; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">THE CALL</div>
          <div style="font-size: 1.2em; color: #fff; font-weight: 600; margin-bottom: 12px;">
            ${primaryDecision.action}${primaryDecision.item ? ` — ${primaryDecision.item}` : ''}
          </div>
          <div style="color: #ccc; margin-bottom: 15px; line-height: 1.5;">
            <strong style="color: #888;">WHY:</strong> ${primaryDecision.reason || 'Highest priority action identified.'}
          </div>
          <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 15px;">
            ${primaryDecision.dollarImpact > 0 ? `
              <div>
                <span style="color: #888; font-size: 0.85em;">IMPACT:</span>
                <span style="color: #4CAF50; font-weight: 600; margin-left: 5px;">$${primaryDecision.dollarImpact.toLocaleString()}</span>
              </div>
            ` : ''}
            <div>
              <span style="color: #888; font-size: 0.85em;">WHEN:</span>
              <span style="color: #fff; margin-left: 5px;">${primaryDecision.timeframeFriendly || primaryDecision.timeframe || 'This week'}</span>
            </div>
          </div>
          ${inactionCost.weeklyLoss > 0 ? `
            <div style="background: rgba(244, 67, 54, 0.1); border: 1px solid rgba(244, 67, 54, 0.3); padding: 10px 12px; border-radius: 4px; margin-bottom: 15px;">
              <span style="color: #f44336; font-weight: 500;">IF YOU DO NOTHING:</span>
              <span style="color: #ff8a80; margin-left: 8px;">-$${inactionCost.weeklyLoss.toLocaleString()}/week</span>
              ${inactionCost.explanation ? `<div style="color: #888; font-size: 0.85em; margin-top: 5px;">${inactionCost.explanation}</div>` : ''}
            </div>
          ` : ''}
          ${alternatives.length > 0 ? `
            <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px;">
              <div style="color: #888; font-size: 0.8em; text-transform: uppercase; margin-bottom: 8px;">ALTERNATIVES</div>
              ${alternatives.slice(0, 2).map(alt => `
                <div style="color: #ccc; padding: 6px 0; display: flex; justify-content: space-between; align-items: center;">
                  <span>→ ${alt.action}</span>
                  ${alt.dollarImpact > 0 ? `<span style="color: #888;">($${alt.dollarImpact.toLocaleString()})</span>` : ''}
                </div>
              `).join('')}
            </div>
          ` : ''}
          ${executiveDecision.confidence && executiveDecision.confidence !== 'high' ? `
            <div style="color: #888; font-size: 0.85em; margin-top: 10px;">
              (${executiveDecision.confidence.charAt(0).toUpperCase() + executiveDecision.confidence.slice(1)} confidence${executiveDecision.confidenceExplanation ? `: ${executiveDecision.confidenceExplanation}` : ''})
            </div>
          ` : ''}
        `;
      } else if (executiveSummary.verdict) {
        // Fall back to verdict if no executive decision
        html += `
          <div style="font-size: 1.1em; color: #fff; font-weight: 600; margin-bottom: 10px;">Current State</div>
          <div style="color: #ccc; line-height: 1.5;">${executiveSummary.verdict}</div>
          ${executiveSummary.topAction ? `<div style="color: #4CAF50; margin-top: 10px; font-weight: 500;">→ ${executiveSummary.topAction}</div>` : ''}
        `;
      } else {
        // Minimum useful state
        const avgMargin = metrics.averageMargin;
        const profitPotential = metrics.totalProfit;
        html += `
          <div style="font-size: 1.1em; color: #fff; font-weight: 600; margin-bottom: 10px;">Inventory Status</div>
          <div style="color: #ccc; line-height: 1.5;">
            ${metrics.totalItems || 0} active SKUs tracked${avgMargin ? ` at ${avgMargin.toFixed(1)}% average margin` : ''}.
            ${profitPotential ? ` $${profitPotential.toLocaleString()} profit potential in current inventory.` : ''}
            ${timeframeOrders > 0 ? ` ${timeframeOrders} orders this ${snapshot.timeframe || 'period'}.` : ''}
          </div>
        `;
      }

      html += '</div>';

      // ═══════════════════════════════════════════════════════════════════════
      // KEY METRICS - Supporting data (not the lead)
      // ═══════════════════════════════════════════════════════════════════════
      html += '<div class="metrics-grid">';

      // Order counts - show timeframe vs context
      html += `
        <div class="metric-card">
          <div class="metric-label">${timeframeLabel} Orders</div>
          ${timeframeOrders > 0 ? renderValue(timeframeOrders) : '<div class="metric-value" style="color: #888;">—</div>'}
          ${timeframeOrders === 0 && last30DaysOrders > 0 ? `<div style="font-size: 0.8em; color: #888; margin-top: 5px;">${last30DaysOrders} in last 30 days</div>` : ''}
        </div>
      `;

      // SKUs sold or inventory count
      if (hasRealData && velocity.uniqueSKUs > 0) {
        html += `
          <div class="metric-card">
            <div class="metric-label">SKUs Sold</div>
            ${renderValue(velocity.uniqueSKUs)}
          </div>
        `;
      } else {
        html += `
          <div class="metric-card">
            <div class="metric-label">Active SKUs</div>
            ${renderValue(metrics.totalItems)}
          </div>
        `;
      }

      // Margin (always useful)
      html += `
        <div class="metric-card">
          <div class="metric-label">Avg Margin</div>
          ${renderValue(metrics.averageMargin, 'percent')}
        </div>
      `;

      // Revenue or Profit based on data availability
      if (metrics.totalProfit && metrics.totalProfit > 0) {
        html += `
          <div class="metric-card">
            <div class="metric-label">Est. Profit Potential</div>
            ${renderValue(metrics.totalProfit, 'currency')}
          </div>
        `;
      } else if (metrics.totalRevenue && metrics.totalRevenue > 0) {
        html += `
          <div class="metric-card">
            <div class="metric-label">Inventory Value</div>
            ${renderValue(metrics.totalRevenue, 'currency')}
          </div>
        `;
      }

      html += '</div>';

      // ORDER CONTEXT BAR - Show 30-day and all-time context
      if (last30DaysOrders > 0 || allTimeOrders > 0) {
        html += `
          <div style="display: flex; gap: 20px; margin: 15px 0; padding: 12px; background: #1a1a2e; border-radius: 4px; font-size: 0.9em;">
            <div>
              <span style="color: #888;">Last 30 days:</span>
              <span style="color: #fff; margin-left: 5px;">${last30DaysOrders} orders</span>
              ${orderContext.last30Days?.totalRevenue ? `<span style="color: #4CAF50; margin-left: 8px;">$${orderContext.last30Days.totalRevenue.toLocaleString()}</span>` : ''}
            </div>
            <div>
              <span style="color: #888;">All time:</span>
              <span style="color: #fff; margin-left: 5px;">${allTimeOrders} orders</span>
              ${orderContext.allTime?.totalRevenue ? `<span style="color: #4CAF50; margin-left: 8px;">$${orderContext.allTime.totalRevenue.toLocaleString()}</span>` : ''}
            </div>
          </div>
        `
      }

      // STATUS MESSAGE - Show reconciled status if available
      if (snapshot.statusMessage) {
        html += `<div style="color: #4CAF50; margin-bottom: 15px; font-size: 0.9em;">${snapshot.statusMessage}</div>`;
      }

      // DECISION INTELLIGENCE (not just recommendations)
      const promotions = recommendations.promotions || [];
      const inventoryActions = recommendations.inventory || [];
      // Note: intelligence, wowInsights, executiveSummary already declared above

      html += '<div class="recommendations" style="margin-top: 30px;">';
      html += '<h4 style="color: #fff;">Decision Intelligence</h4>';

      // WOW INSIGHTS - The headline insights operators need
      if (wowInsights.length > 0) {
        html += `
          <div class="recommendation-section" style="background: linear-gradient(135deg, #1a2a1a 0%, #0a1a0a 100%); border-left: 3px solid #4CAF50;">
            <h4 style="color: #4CAF50;">Key Opportunities</h4>
            ${wowInsights.slice(0, 3).map(wow => `
              <div class="recommendation-item" style="padding: 15px; margin-bottom: 10px;">
                <div style="font-size: 1.1em; color: #fff; margin-bottom: 8px;">
                  <strong>${wow.headline || 'Opportunity Identified'}</strong>
                </div>
                <div style="color: #ccc; margin-bottom: 8px;">${wow.insight || ''}</div>
                <div style="color: #4CAF50; font-weight: 500;">→ ${wow.action || 'Take action'}</div>
                ${wow.dollarImpact ? `<div style="color: #FFD700; margin-top: 5px;">Potential impact: $${wow.dollarImpact.toLocaleString()}</div>` : ''}
              </div>
            `).join('')}
          </div>
        `;
      }

      // URGENT ACTIONS - Things that need immediate attention
      const urgentActions = inventoryActions.filter(r => r.severity === 'high' || r.action === 'REORDER_URGENT');
      if (urgentActions.length > 0) {
        html += `
          <div class="recommendation-section" style="background: linear-gradient(135deg, #2a1a1a 0%, #1a0a0a 100%); border-left: 3px solid #f44336;">
            <h4 style="color: #f44336;">Urgent Actions Required</h4>
            ${urgentActions.slice(0, 3).map(rec => {
              const margin = rec.triggeringMetrics?.margin;
              const quantity = rec.triggeringMetrics?.quantity || 0;
              const dollarAtRisk = margin && quantity ? Math.round(quantity * (rec.triggeringMetrics?.retail || 0) * (margin / 100)) : null;
              return `
                <div class="recommendation-item" style="padding: 12px; margin-bottom: 8px;">
                  <strong style="color: #fff;">${rec.name || 'Unknown'}</strong>
                  <div style="color: #ccc; margin: 5px 0;">${rec.reason || 'Action needed'}</div>
                  ${dollarAtRisk ? `<div style="color: #f44336;">$${dollarAtRisk.toLocaleString()} at risk</div>` : ''}
                </div>
              `;
            }).join('')}
          </div>
        `;
      }

      // PROMOTION OPPORTUNITIES - With dollar context
      if (promotions.length > 0) {
        html += `
          <div class="recommendation-section">
            <h4>Promotion Opportunities</h4>
            ${promotions.slice(0, 5).map(rec => {
              const margin = rec.triggeringMetrics?.margin;
              const velocity = rec.triggeringMetrics?.velocity;
              return `
                <div class="recommendation-item" style="padding: 12px; margin-bottom: 8px;">
                  <strong style="color: #fff;">${rec.name || 'Unknown'}</strong>
                  ${margin ? `<span style="color: #4CAF50; margin-left: 10px;">${margin.toFixed(1)}% margin</span>` : ''}
                  <div style="color: #ccc; margin: 5px 0;">${rec.reason || 'Good promotion candidate'}</div>
                  ${velocity ? `<div style="color: #888; font-size: 0.9em;">Moving ${velocity} units/day</div>` : ''}
                </div>
              `;
            }).join('')}
          </div>
        `;
      }

      // INVENTORY MONITORING - Non-urgent items
      const monitorItems = inventoryActions.filter(r => r.severity !== 'high' && r.action !== 'REORDER_URGENT');
      if (monitorItems.length > 0) {
        html += `
          <div class="recommendation-section">
            <h4>Monitor These Items</h4>
            ${monitorItems.slice(0, 3).map(rec => `
              <div class="recommendation-item" style="padding: 10px; margin-bottom: 6px;">
                <strong style="color: #fff;">${rec.name || 'Unknown'}</strong>
                <div style="color: #888; font-size: 0.9em;">${rec.reason || 'Keep an eye on this'}</div>
              </div>
            `).join('')}
          </div>
        `;
      }

      // EXECUTIVE SUMMARY - If available
      if (executiveSummary.verdict) {
        html += `
          <div class="recommendation-section" style="margin-top: 20px; background: #1a1a2e; padding: 15px; border-radius: 4px;">
            <h4 style="color: #fff; margin-bottom: 10px;">Bottom Line</h4>
            <div style="color: #ccc;">${executiveSummary.verdict}</div>
            ${executiveSummary.topAction ? `<div style="color: #4CAF50; margin-top: 10px;">→ ${executiveSummary.topAction}</div>` : ''}
          </div>
        `;
      }

      // Fallback if nothing to show
      if (wowInsights.length === 0 && promotions.length === 0 && inventoryActions.length === 0) {
        html += '<p style="color: #888; padding: 15px; background: #1a1a1a; border-radius: 4px;">Generate a snapshot to see decision intelligence.</p>';
      }

      html += '</div>';

      document.getElementById('snapshotContent').innerHTML = html;
      document.getElementById('snapshotPreview').classList.add('show');
    }

    // ============================================================================
    // CHAT
    // ============================================================================

    let conversationHistory = [];

    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (!message) return;

      addChatMessage('user', message);
      input.value = '';

      const thinkingId = addChatMessage('assistant', 'Thinking...');

      try {
        const response = await fetch(`${BACKEND_URL}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, conversationHistory })
        });

        const data = await response.json();
        document.getElementById(thinkingId).remove();

        // Render confidence and warnings
        renderConfidence('chat', data.confidence, data.data_freshness);
        renderWarnings('chat', data.warnings);

        if (data.response) {
          addChatMessage('assistant', data.response, data.confidence);

          conversationHistory.push(
            { role: 'user', content: message },
            { role: 'assistant', content: data.response }
          );

          if (conversationHistory.length > 20) {
            conversationHistory = conversationHistory.slice(-20);
          }
        } else {
          addChatMessage('assistant', 'Unable to respond.', 'low');
        }
      } catch (error) {
        document.getElementById(thinkingId).remove();
        addChatMessage('assistant', `Error: ${error.message}`, 'low');
        renderWarnings('chat', [error.message]);
      }
    }

    function addChatMessage(role, content, confidence = null) {
      const messagesDiv = document.getElementById('chatMessages');
      const messageId = 'msg-' + Date.now();

      // Clear placeholder
      const placeholder = messagesDiv.querySelector('[style*="Ask OMEN"]');
      if (placeholder) messagesDiv.innerHTML = '';

      const messageDiv = document.createElement('div');
      messageDiv.id = messageId;
      messageDiv.className = `chat-message ${role}`;

      const roleLabel = document.createElement('div');
      roleLabel.className = 'chat-role';
      roleLabel.textContent = role === 'user' ? 'YOU' : 'OMEN';

      const contentDiv = document.createElement('div');
      contentDiv.className = 'chat-content';
      contentDiv.textContent = content;

      messageDiv.appendChild(roleLabel);
      messageDiv.appendChild(contentDiv);

      // Show confidence on assistant messages
      if (role === 'assistant' && confidence) {
        const metaDiv = document.createElement('div');
        metaDiv.className = 'chat-meta';
        metaDiv.textContent = `Confidence: ${confidence.toUpperCase()}`;
        messageDiv.appendChild(metaDiv);
      }

      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      return messageId;
    }

    // ============================================================================
    // NAVIGATION
    // ============================================================================

    function showSection(section) {
      document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.nav a').forEach(el => el.classList.remove('active'));

      if (section === 'chat') {
        document.getElementById('chatSection').classList.add('active');
        document.getElementById('navChat').classList.add('active');
      } else {
        document.getElementById('snapshotSection').classList.add('active');
        document.getElementById('navSnapshot').classList.add('active');
      }
    }

    // ============================================================================
    // INIT
    // ============================================================================
    console.log('OMEN Vault initialized');
  </script>
</body>
</html>
