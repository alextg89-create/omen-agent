<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OMEN Vault</title>
  <!-- Supabase JS Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Auth config from env vars -->
  <script src="/auth-config.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: #1a1a1a;
      color: #e0e0e0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #242424;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }

    h1 {
      margin-bottom: 10px;
      color: #fff;
    }

    .nav {
      margin-bottom: 30px;
      border-bottom: 1px solid #333;
      padding-bottom: 15px;
    }

    .nav a {
      margin-right: 20px;
      text-decoration: none;
      color: #888;
      font-weight: 500;
      padding: 8px 0;
      transition: color 0.2s;
    }

    .nav a:hover, .nav a.active {
      color: #fff;
    }

    h2 {
      margin-top: 30px;
      margin-bottom: 15px;
      color: #fff;
    }

    .description {
      color: #888;
      margin-bottom: 20px;
    }

    /* CONFIDENCE STRIP - TRUTH RENDERING */
    .confidence-strip {
      padding: 12px 16px;
      border-radius: 4px;
      margin-bottom: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .confidence-high {
      background: rgba(40, 167, 69, 0.15);
      border: 1px solid #28a745;
      color: #28a745;
    }

    .confidence-medium {
      background: rgba(255, 152, 0, 0.15);
      border: 1px solid #ff9800;
      color: #ff9800;
    }

    .confidence-low {
      background: rgba(220, 53, 69, 0.15);
      border: 1px solid #dc3545;
      color: #dc3545;
    }

    .confidence-unknown {
      background: rgba(108, 117, 125, 0.15);
      border: 1px solid #6c757d;
      color: #6c757d;
    }

    /* WARNINGS PANEL - NON-DISMISSIBLE, ABOVE RESPONSE */
    .warnings-panel {
      background: rgba(220, 53, 69, 0.1);
      border: 1px solid #dc3545;
      border-radius: 4px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .warnings-panel h4 {
      color: #dc3545;
      margin-bottom: 10px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .warnings-panel ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .warnings-panel li {
      color: #ff6b6b;
      padding: 6px 0;
      border-bottom: 1px solid rgba(220, 53, 69, 0.2);
      font-size: 14px;
    }

    .warnings-panel li:last-child {
      border-bottom: none;
    }

    /* DATA FRESHNESS INDICATOR */
    .freshness-indicator {
      font-size: 12px;
      color: #888;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .freshness-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .freshness-fresh { background: #28a745; }
    .freshness-aging { background: #ff9800; }
    .freshness-stale { background: #dc3545; }
    .freshness-unknown { background: #6c757d; }

    /* ACTION CARDS - Executive Brief */
    .action-brief {
      margin-top: 30px;
    }

    .action-brief-headline {
      font-size: 1.3em;
      color: #fff;
      padding: 20px;
      background: linear-gradient(135deg, #1a2a3a 0%, #0a1a2a 100%);
      border-radius: 8px;
      margin-bottom: 25px;
      border-left: 4px solid #4CAF50;
    }

    .action-brief-section {
      margin-bottom: 25px;
    }

    .action-brief-section h4 {
      font-size: 0.85em;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 1px solid #333;
    }

    .action-card {
      background: #1e1e2e;
      border-radius: 8px;
      padding: 18px;
      margin-bottom: 12px;
      border-left: 4px solid #888;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .action-card:hover {
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .action-card.reorder-now {
      border-left-color: #f44336;
      background: linear-gradient(135deg, #2a1a1a 0%, #1e1e2e 100%);
    }

    .action-card.sell-now {
      border-left-color: #ff9800;
      background: linear-gradient(135deg, #2a2a1a 0%, #1e1e2e 100%);
    }

    .action-card.hold-line {
      border-left-color: #4CAF50;
      background: linear-gradient(135deg, #1a2a1a 0%, #1e1e2e 100%);
    }

    .action-card.deprioritize {
      border-left-color: #666;
      opacity: 0.7;
    }

    .action-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .action-card-action {
      font-size: 0.7em;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .action-card-action.reorder-now {
      background: rgba(244, 67, 54, 0.2);
      color: #f44336;
    }

    .action-card-action.sell-now {
      background: rgba(255, 152, 0, 0.2);
      color: #ff9800;
    }

    .action-card-action.hold-line {
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
    }

    .action-card-timeframe {
      font-size: 0.75em;
      color: #888;
      text-transform: uppercase;
    }

    .action-card-sku {
      font-size: 1.1em;
      font-weight: 600;
      color: #fff;
      margin-bottom: 8px;
    }

    .action-card-why {
      color: #aaa;
      font-size: 0.9em;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .action-card-todo {
      color: #4CAF50;
      font-weight: 500;
      margin-bottom: 10px;
    }

    .action-card-money {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: rgba(0,0,0,0.2);
      border-radius: 4px;
      font-size: 0.9em;
    }

    .action-card-money.at-risk {
      border: 1px solid rgba(244, 67, 54, 0.3);
      color: #f44336;
    }

    .action-card-money.opportunity {
      border: 1px solid rgba(255, 152, 0, 0.3);
      color: #ff9800;
    }

    .action-card-money.protect {
      border: 1px solid rgba(76, 175, 80, 0.3);
      color: #4CAF50;
    }

    .ignore-summary {
      padding: 15px;
      background: #1a1a1a;
      border-radius: 4px;
      color: #666;
      font-size: 0.9em;
      text-align: center;
    }

    /* ═══════════════════════════════════════════════════════════════════════
       MIND-BLOWING UI STYLES - Make Wix look like a joke
       ═══════════════════════════════════════════════════════════════════════ */

    /* URGENT ALERT BANNER */
    .urgent-banner {
      background: linear-gradient(135deg, #2a1a2a 0%, #1a1a2a 100%);
      border: 1px solid #8b5cf6;
      border-radius: 12px;
      padding: 20px 24px;
      margin-bottom: 24px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }

    .urgent-stat {
      text-align: center;
    }

    .urgent-stat-icon {
      font-size: 1.5em;
      margin-bottom: 4px;
    }

    .urgent-stat-value {
      font-size: 1.8em;
      font-weight: 700;
      color: #fff;
    }

    .urgent-stat-label {
      font-size: 0.8em;
      color: #a0a0a0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* INVENTORY HEALTH BAR */
    .health-section {
      background: #1e1e2e;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .health-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .health-title {
      font-size: 1em;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .health-percentage {
      font-size: 2em;
      font-weight: 700;
      color: #4ade80;
    }

    .health-bar-container {
      background: #2a2a3a;
      border-radius: 8px;
      height: 24px;
      overflow: hidden;
      display: flex;
      margin-bottom: 16px;
    }

    .health-bar-segment {
      height: 100%;
      transition: width 0.5s ease;
    }

    .health-bar-healthy { background: linear-gradient(90deg, #22c55e, #4ade80); }
    .health-bar-slow { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
    .health-bar-critical { background: linear-gradient(90deg, #ef4444, #f87171); }
    .health-bar-dead { background: linear-gradient(90deg, #6b7280, #9ca3af); }

    .health-legend {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    .health-legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85em;
    }

    .health-legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }

    .health-legend-count {
      color: #fff;
      font-weight: 600;
    }

    .health-legend-label {
      color: #888;
    }

    /* PRIORITY ACTION CARDS */
    .priority-section {
      margin-bottom: 24px;
    }

    .priority-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .priority-title {
      font-size: 1.1em;
      font-weight: 600;
      color: #fff;
    }

    .priority-badge {
      font-size: 0.75em;
      padding: 4px 12px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .priority-badge-today { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .priority-badge-week { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }

    .priority-card {
      background: #1e1e2e;
      border-radius: 12px;
      padding: 20px 24px;
      margin-bottom: 12px;
      border-left: 4px solid #888;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .priority-card:hover {
      transform: translateX(4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }

    .priority-card.urgent { border-left-color: #ef4444; background: linear-gradient(135deg, #2a1a1a 0%, #1e1e2e 100%); }
    .priority-card.warning { border-left-color: #f59e0b; background: linear-gradient(135deg, #2a2a1a 0%, #1e1e2e 100%); }
    .priority-card.success { border-left-color: #22c55e; background: linear-gradient(135deg, #1a2a1a 0%, #1e1e2e 100%); }

    .priority-card-badge {
      display: inline-block;
      font-size: 0.7em;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 4px 10px;
      border-radius: 4px;
      margin-bottom: 12px;
    }

    .priority-card-badge.reorder { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .priority-card-badge.promote { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
    .priority-card-badge.protect { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .priority-card-badge.clear { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }

    .priority-card-name {
      font-size: 1.2em;
      font-weight: 600;
      color: #fff;
      margin-bottom: 12px;
    }

    .priority-card-section {
      margin-bottom: 12px;
    }

    .priority-card-label {
      font-size: 0.75em;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .priority-card-value {
      color: #ccc;
      line-height: 1.5;
    }

    .priority-card-outcome {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: rgba(0,0,0,0.2);
      border-radius: 6px;
      margin-top: 12px;
    }

    .priority-card-outcome.risk { border: 1px solid rgba(239, 68, 68, 0.3); }
    .priority-card-outcome.opportunity { border: 1px solid rgba(245, 158, 11, 0.3); }
    .priority-card-outcome.protect { border: 1px solid rgba(34, 197, 94, 0.3); }

    .priority-card-outcome-icon { font-size: 1.2em; }
    .priority-card-outcome-text { font-weight: 600; }
    .priority-card-outcome.risk .priority-card-outcome-text { color: #f87171; }
    .priority-card-outcome.opportunity .priority-card-outcome-text { color: #fbbf24; }
    .priority-card-outcome.protect .priority-card-outcome-text { color: #4ade80; }

    .priority-card-action-btn {
      display: inline-block;
      margin-top: 12px;
      padding: 8px 16px;
      background: rgba(139, 92, 246, 0.2);
      color: #a78bfa;
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 6px;
      font-size: 0.85em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .priority-card-action-btn:hover {
      background: rgba(139, 92, 246, 0.3);
    }

    /* PERFORMANCE SECTION */
    .performance-section {
      background: #1e1e2e;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .performance-title {
      font-size: 1em;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 20px;
    }

    .performance-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }

    .performance-stat {
      text-align: center;
    }

    .performance-stat-value {
      font-size: 1.8em;
      font-weight: 700;
      color: #fff;
    }

    .performance-stat-label {
      font-size: 0.8em;
      color: #888;
      margin-top: 4px;
    }

    .performance-insights {
      border-top: 1px solid #333;
      padding-top: 16px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .performance-insight {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .performance-insight-icon {
      font-size: 1.2em;
    }

    .performance-insight-label {
      font-size: 0.75em;
      color: #888;
      text-transform: uppercase;
    }

    .performance-insight-value {
      color: #fff;
      font-weight: 500;
    }

    /* EMPTY STATE */
    .empty-actions {
      background: #1e1e2e;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      margin-bottom: 24px;
    }

    .empty-actions-icon {
      font-size: 3em;
      margin-bottom: 16px;
    }

    .empty-actions-title {
      font-size: 1.2em;
      color: #fff;
      margin-bottom: 8px;
    }

    .empty-actions-text {
      color: #888;
    }

    /* REFUSAL STATE */
    .refusal-state {
      background: rgba(220, 53, 69, 0.1);
      border: 2px solid #dc3545;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      margin: 20px 0;
    }

    .refusal-state h3 {
      color: #dc3545;
      margin-bottom: 15px;
    }

    .refusal-state p {
      color: #888;
      max-width: 500px;
      margin: 0 auto;
    }

    /* FORM ELEMENTS */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #ccc;
    }

    input[type="email"],
    input[type="date"],
    input[type="text"],
    select {
      width: 100%;
      max-width: 400px;
      padding: 10px;
      border: 1px solid #444;
      border-radius: 4px;
      font-size: 14px;
      background: #1a1a1a;
      color: #e0e0e0;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #0066cc;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: #0066cc;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #0052a3;
    }

    .btn-secondary {
      background: #28a745;
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #218838;
    }

    /* STATUS MESSAGE */
    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
      display: none;
    }

    .status.show {
      display: block;
    }

    .status.success {
      background: rgba(40, 167, 69, 0.15);
      border: 1px solid #28a745;
      color: #28a745;
    }

    .status.error {
      background: rgba(220, 53, 69, 0.15);
      border: 1px solid #dc3545;
      color: #dc3545;
    }

    .status.loading {
      background: rgba(0, 102, 204, 0.15);
      border: 1px solid #0066cc;
      color: #6db3f2;
    }

    /* SNAPSHOT PREVIEW */
    .snapshot-preview {
      margin-top: 30px;
      padding: 20px;
      background: #1a1a1a;
      border-radius: 4px;
      border: 1px solid #333;
      display: none;
    }

    .snapshot-preview.show {
      display: block;
    }

    /* METRICS GRID */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .metric-card {
      padding: 15px;
      background: #242424;
      border-radius: 4px;
      border: 1px solid #333;
    }

    .metric-label {
      font-size: 11px;
      color: #888;
      text-transform: uppercase;
      margin-bottom: 5px;
      letter-spacing: 0.5px;
    }

    .metric-value {
      font-size: 24px;
      font-weight: bold;
      color: #fff;
    }

    .metric-value.zero {
      color: #ff9800;
    }

    .metric-value.null {
      color: #dc3545;
    }

    /* RECOMMENDATIONS */
    .recommendations {
      margin-top: 20px;
    }

    .recommendation-section {
      margin-bottom: 20px;
    }

    .recommendation-section h4 {
      margin-bottom: 10px;
      color: #ccc;
    }

    .recommendation-item {
      padding: 12px;
      background: #1a1a1a;
      border-left: 3px solid #0066cc;
      margin-bottom: 10px;
      border-radius: 2px;
    }

    .recommendation-item strong {
      color: #fff;
    }

    .recommendation-item small {
      color: #888;
      display: block;
      margin-top: 5px;
    }

    .help-text {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    /* CHAT */
    #chatMessages {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 15px;
      height: 400px;
      overflow-y: auto;
      margin-bottom: 15px;
    }

    .chat-message {
      margin-bottom: 15px;
      padding: 10px 15px;
      border-radius: 8px;
    }

    .chat-message.user {
      background: #0066cc;
      color: white;
      margin-left: 60px;
      text-align: right;
    }

    .chat-message.assistant {
      background: #333;
      color: #e0e0e0;
      margin-right: 60px;
    }

    .chat-role {
      font-size: 11px;
      font-weight: bold;
      margin-bottom: 5px;
      opacity: 0.8;
    }

    .chat-content {
      white-space: pre-wrap;
      line-height: 1.5;
    }

    .chat-meta {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(255,255,255,0.1);
      font-size: 11px;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>OMEN Vault</h1>
    <p class="description">Operations Intelligence. Truth only.</p>

    <div class="nav" style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <a href="#" onclick="showSection('chat'); return false;" id="navChat">Chat</a>
        <a href="#" onclick="showSection('snapshot'); return false;" id="navSnapshot" class="active">Snapshot</a>
      </div>
      <button onclick="handleLogout()" style="background: transparent; border: 1px solid #444; color: #888; padding: 6px 12px; font-size: 12px;">Logout</button>
    </div>

    <!-- CHAT SECTION -->
    <div id="chatSection" class="section">
      <h2>Ask OMEN</h2>

      <!-- CHAT WARNINGS (rendered above response) -->
      <div id="chatWarnings" class="warnings-panel" style="display: none;">
        <h4>Warnings</h4>
        <ul id="chatWarningsList"></ul>
      </div>

      <!-- CHAT CONFIDENCE STRIP -->
      <div id="chatConfidence" class="confidence-strip confidence-unknown" style="display: none;">
        <span id="chatConfidenceLabel">Unknown</span>
        <span class="freshness-indicator">
          <span id="chatFreshnessDot" class="freshness-dot freshness-unknown"></span>
          <span id="chatFreshnessText">No data</span>
        </span>
      </div>

      <div id="chatMessages">
        <div style="color: #666; text-align: center; margin-top: 170px;">Ask OMEN about your inventory...</div>
      </div>

      <div style="display: flex; gap: 10px;">
        <input type="text" id="chatInput" placeholder="What should I promote this week?" onkeypress="if(event.key==='Enter') sendChatMessage()">
        <button onclick="sendChatMessage()" class="btn-primary">Send</button>
      </div>
    </div>

    <!-- SNAPSHOT SECTION -->
    <div id="snapshotSection" class="section active">
      <h2>Operations Snapshot</h2>

      <!-- SNAPSHOT WARNINGS (rendered above everything) -->
      <div id="snapshotWarnings" class="warnings-panel" style="display: none;">
        <h4>Warnings</h4>
        <ul id="snapshotWarningsList"></ul>
      </div>

      <!-- SNAPSHOT CONFIDENCE STRIP -->
      <div id="snapshotConfidence" class="confidence-strip confidence-unknown" style="display: none;">
        <span id="snapshotConfidenceLabel">Unknown</span>
        <span class="freshness-indicator">
          <span id="snapshotFreshnessDot" class="freshness-dot freshness-unknown"></span>
          <span id="snapshotFreshnessText">No data</span>
        </span>
      </div>

      <div class="form-group">
        <label for="timeframeInput">Timeframe</label>
        <select id="timeframeInput" onchange="handleTimeframeChange()">
          <option value="weekly">Weekly</option>
          <option value="daily">Daily</option>
          <option value="monthly">Monthly</option>
          <option value="custom">Custom Range</option>
        </select>
      </div>

      <!-- Custom Date Range (shown when custom is selected) -->
      <div id="customDateRange" class="form-group" style="display: none;">
        <div style="display: flex; gap: 10px; align-items: center;">
          <div>
            <label for="startDateInput">Start Date</label>
            <input type="date" id="startDateInput" style="background: #2a2a3e; border: 1px solid #3a3a5e; color: #fff; padding: 8px; border-radius: 4px;">
          </div>
          <div>
            <label for="endDateInput">End Date</label>
            <input type="date" id="endDateInput" style="background: #2a2a3e; border: 1px solid #3a3a5e; color: #fff; padding: 8px; border-radius: 4px;">
          </div>
        </div>
      </div>

      <div class="button-group">
        <button id="generateBtn" class="btn-primary" onclick="generateSnapshot()">Generate Snapshot</button>
      </div>

      <div id="statusMessage" class="status"></div>

      <!-- REFUSAL STATE (shown when authority unavailable) -->
      <div id="refusalState" class="refusal-state" style="display: none;">
        <h3>Cannot Provide Intelligence</h3>
        <p id="refusalMessage">Authority unavailable.</p>
      </div>

      <!-- SNAPSHOT PREVIEW -->
      <div id="snapshotPreview" class="snapshot-preview">
        <div id="snapshotContent"></div>
      </div>
    </div>
  </div>

  <script>
    // ============================================================================
    // AUTH GUARD - Redirect to login if not authenticated
    // ============================================================================
    let supabaseAuth = null;

    (async function authGuard() {
      // Hide app until auth is verified
      document.body.style.visibility = 'hidden';

      // Check if Supabase config is available
      if (!window.SUPABASE_CONFIG || !window.SUPABASE_CONFIG.url || !window.SUPABASE_CONFIG.anonKey) {
        console.error('Supabase config not available');
        window.location.href = '/login.html';
        return;
      }

      // Initialize Supabase client
      supabaseAuth = window.supabase.createClient(
        window.SUPABASE_CONFIG.url,
        window.SUPABASE_CONFIG.anonKey
      );

      try {
        const { data: { session } } = await supabaseAuth.auth.getSession();

        if (!session) {
          // Not logged in, redirect to login
          window.location.href = '/login.html';
          return;
        }

        // Logged in, show app
        document.body.style.visibility = 'visible';
      } catch (err) {
        console.error('Auth check failed:', err);
        window.location.href = '/login.html';
      }
    })();

    // Logout handler
    async function handleLogout() {
      if (supabaseAuth) {
        await supabaseAuth.auth.signOut();
      }
      window.location.href = '/login.html';
    }

    // ============================================================================
    // CONFIGURATION
    // ============================================================================
    const BACKEND_URL = window.location.origin;

    // ============================================================================
    // STATE
    // ============================================================================
    let currentSnapshot = null;
    let inventoryLastSyncedAt = null;

    // ============================================================================
    // TRUTH RENDERING UTILITIES
    // ============================================================================

    /**
     * Render confidence strip - VERBATIM from response
     * No defaults. No inference. Truth only.
     */
    function renderConfidence(elementPrefix, confidence, dataFreshness) {
      const strip = document.getElementById(`${elementPrefix}Confidence`);
      const label = document.getElementById(`${elementPrefix}ConfidenceLabel`);
      const dot = document.getElementById(`${elementPrefix}FreshnessDot`);
      const text = document.getElementById(`${elementPrefix}FreshnessText`);

      if (!strip) return;

      // Remove all confidence classes
      strip.classList.remove('confidence-high', 'confidence-medium', 'confidence-low', 'confidence-unknown');
      dot.classList.remove('freshness-fresh', 'freshness-aging', 'freshness-stale', 'freshness-unknown');

      // Render confidence VERBATIM
      if (confidence === 'high') {
        strip.classList.add('confidence-high');
        label.textContent = 'HIGH CONFIDENCE';
      } else if (confidence === 'medium') {
        strip.classList.add('confidence-medium');
        label.textContent = 'MEDIUM CONFIDENCE';
      } else if (confidence === 'low') {
        strip.classList.add('confidence-low');
        label.textContent = 'LOW CONFIDENCE';
      } else {
        strip.classList.add('confidence-unknown');
        label.textContent = 'UNKNOWN';
      }

      // Render freshness - ORDER-DRIVEN MODEL
      // ========================================================================
      // CRITICAL: Snapshot age is INFORMATIONAL ONLY
      // Availability = snapshot_quantity - sold_quantity (updates in real-time)
      // Orders flowing = data is accurate regardless of snapshot age
      // ========================================================================
      if (dataFreshness) {
        const model = dataFreshness.model || 'order-driven';
        const hours = dataFreshness.age_hours || 0;
        const days = hours > 0 ? Math.floor(hours / 24) : 0;

        // ORDER-DRIVEN MODEL: Always show green when orders exist
        // Snapshot age is informational, NOT a quality indicator
        if (model === 'order-driven' || model === 'order_driven') {
          dot.classList.add('freshness-fresh');  // Always green for order-driven
          if (days === 0) {
            text.textContent = 'Order-driven • Current';
          } else if (days === 1) {
            text.textContent = 'Order-driven • 1d';
          } else {
            text.textContent = `Order-driven • ${days}d`;
          }
        } else {
          // SNAPSHOT-ONLY: Show age informatively (no scary language)
          dot.classList.add('freshness-fresh');
          text.textContent = days > 0 ? `Snapshot • ${days}d` : 'Snapshot • Current';
        }
      } else {
        // No data freshness info available
        dot.classList.add('freshness-unknown');
        text.textContent = 'Loading...';
      }

      strip.style.display = 'flex';
    }

    /**
     * Render warnings - ALWAYS VISIBLE, NOT DISMISSIBLE, ABOVE RESPONSE
     */
    function renderWarnings(elementPrefix, warnings) {
      const panel = document.getElementById(`${elementPrefix}Warnings`);
      const list = document.getElementById(`${elementPrefix}WarningsList`);

      if (!panel || !list) return;

      if (!warnings || warnings.length === 0) {
        panel.style.display = 'none';
        return;
      }

      list.innerHTML = '';
      warnings.forEach(warning => {
        const li = document.createElement('li');
        li.textContent = warning;
        list.appendChild(li);
      });

      panel.style.display = 'block';
    }

    /**
     * Render value - STRICT VALIDATION
     * - NULL/undefined = absence → refusal marker "—"
     * - NaN/Infinity = invalid → refusal marker "—"
     * - 0 = valid zero → render as "0"
     * - Valid number → render formatted
     */
    function renderValue(value, format = 'number') {
      // NULL/UNDEFINED = ABSENCE → Refusal marker
      if (value === null || value === undefined) {
        return '<span class="metric-value null">—</span>';
      }

      // NaN/Infinity = INVALID → Refusal marker (NEVER show NaN)
      if (typeof value === 'number' && (!isFinite(value) || Number.isNaN(value))) {
        console.warn('[UI] renderValue: Suppressed NaN/Infinity value');
        return '<span class="metric-value null">—</span>';
      }

      // ZERO = FACT → Render as zero
      if (value === 0) {
        if (format === 'currency') {
          return '<span class="metric-value zero">$0.00</span>';
        }
        if (format === 'percent') {
          return '<span class="metric-value zero">0%</span>';
        }
        return '<span class="metric-value zero">0</span>';
      }

      // Valid value → Render normally
      if (format === 'currency') {
        return `<span class="metric-value">${formatCurrency(value)}</span>`;
      }
      if (format === 'percent') {
        return `<span class="metric-value">${formatPercent(value)}</span>`;
      }
      return `<span class="metric-value">${value}</span>`;
    }

    function formatCurrency(value) {
      // STRICT: Must be finite number
      if (typeof value !== 'number' || !isFinite(value) || Number.isNaN(value)) {
        console.warn('[UI] formatCurrency: Invalid value', value);
        return '—';
      }
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
      }).format(value);
    }

    function formatPercent(value) {
      // STRICT: Must be finite number
      if (value === null || value === undefined) return '—';
      if (typeof value !== 'number' || !isFinite(value) || Number.isNaN(value)) {
        console.warn('[UI] formatPercent: Invalid value', value);
        return '—';
      }
      return `${value.toFixed(1)}%`;
    }

    /**
     * ════════════════════════════════════════════════════════════════════════════
     * ACTION CARD VALIDATION - PART A
     * ════════════════════════════════════════════════════════════════════════════
     *
     * MANDATORY: Cards are ONLY rendered when ALL required fields are valid.
     * Invalid cards are SILENTLY SUPPRESSED - no "Unknown", no NaN, no fallbacks.
     *
     * Snapshot prefers SILENCE over LOW-CONFIDENCE OUTPUT.
     */
    function isValidActionCard(card) {
      if (!card) return false;

      // REQUIRED: Product identification (non-empty string)
      const name = card.name || card.sku;
      if (!name || typeof name !== 'string' || name.trim() === '') {
        console.debug('[UI] Suppressed card: missing name/sku');
        return false;
      }

      // REJECT: "Unknown" placeholders
      const nameLower = name.toLowerCase();
      if (nameLower.includes('unknown') || nameLower === 'unknown sku') {
        console.debug('[UI] Suppressed card: contains "Unknown"', name);
        return false;
      }

      // REQUIRED: Actionable instruction (non-generic)
      const action = card.whatToDo || '';
      if (!action || typeof action !== 'string' || action.trim() === '') {
        console.debug('[UI] Suppressed card: missing whatToDo', name);
        return false;
      }

      // REJECT: Generic advice without specifics
      const actionLower = action.toLowerCase();
      const genericPatterns = [
        'take action',
        'discount slow movers',
        'consider discounting',
        'review inventory'
      ];
      if (genericPatterns.some(p => actionLower.includes(p)) && !card.sku) {
        console.debug('[UI] Suppressed card: generic advice without SKU', action);
        return false;
      }

      // REQUIRED: Reason/why (non-empty)
      const reason = card.why || card.reason;
      if (!reason || typeof reason !== 'string' || reason.trim() === '') {
        console.debug('[UI] Suppressed card: missing reason', name);
        return false;
      }

      // REQUIRED: Valid numeric in moneyImpact OR metrics
      if (!validateMoneyField(card)) {
        console.debug('[UI] Suppressed card: invalid/NaN money values', name);
        return false;
      }

      // REQUIRED: Valid quantity data (if present, must be finite)
      const metrics = card.metrics || {};
      if (metrics.quantity !== undefined) {
        if (typeof metrics.quantity !== 'number' || !isFinite(metrics.quantity)) {
          console.debug('[UI] Suppressed card: invalid quantity', name, metrics.quantity);
          return false;
        }
      }

      return true;
    }

    /**
     * Validate money fields - must be finite numbers or properly formatted strings
     */
    function validateMoneyField(card) {
      const metrics = card.metrics || {};

      // If profitPerUnit exists, it must be finite
      if (metrics.profitPerUnit !== undefined && metrics.profitPerUnit !== null) {
        if (typeof metrics.profitPerUnit !== 'number' || !isFinite(metrics.profitPerUnit)) {
          return false;
        }
      }

      // If totalProfitAtRisk exists, it must be finite
      if (metrics.totalProfitAtRisk !== undefined && metrics.totalProfitAtRisk !== null) {
        if (typeof metrics.totalProfitAtRisk !== 'number' || !isFinite(metrics.totalProfitAtRisk)) {
          return false;
        }
      }

      // If moneyImpact string contains NaN, reject
      const moneyImpact = card.moneyImpact || '';
      if (typeof moneyImpact === 'string' && moneyImpact.toLowerCase().includes('nan')) {
        return false;
      }

      // If moneyImpact is numeric, must be finite
      if (typeof moneyImpact === 'number' && !isFinite(moneyImpact)) {
        return false;
      }

      return true;
    }

    /**
     * ════════════════════════════════════════════════════════════════════════════
     * ACTION CARD RENDERING - PART B
     * ════════════════════════════════════════════════════════════════════════════
     *
     * Each card has:
     * - ACTION: SELL NOW / REORDER NOW / HOLD LINE / DEPRIORITIZE
     * - SKU: name (REQUIRED - no fallbacks)
     * - WHY: one sentence (REQUIRED)
     * - WHAT TO DO: specific action (REQUIRED - no generic)
     * - MONEY IMPACT: $ at risk or opportunity (finite number)
     * - TIMEFRAME: TODAY / THIS WEEK / SOON
     *
     * Returns EMPTY STRING if validation fails - card is silently suppressed.
     */
    function renderActionCard(card) {
      // ════════════════════════════════════════════════════════════════════════
      // VALIDATION GATE: Reject invalid cards silently
      // ════════════════════════════════════════════════════════════════════════
      if (!isValidActionCard(card)) {
        return ''; // SILENT SUPPRESSION - no placeholder, no "Unknown"
      }

      const decision = card.decision || 'DEPRIORITIZE';
      const cardClass = decision.toLowerCase().replace('_', '-');

      // Determine money impact styling
      let moneyClass = 'opportunity';
      if (decision === 'REORDER_NOW') {
        moneyClass = 'at-risk';
      } else if (decision === 'HOLD_LINE') {
        moneyClass = 'protect';
      } else if (decision === 'SELL_NOW') {
        moneyClass = 'opportunity';
      }

      // Format timeframe label
      const timeframeLabels = {
        'TODAY': 'Today',
        'THIS_WEEK': 'This Week',
        'SOON': 'Soon',
        'ONGOING': 'Ongoing',
        'NONE': ''
      };
      const timeframeLabel = timeframeLabels[card.timeframe] || card.timeframe || '';

      // Format action label
      const actionLabels = {
        'REORDER_NOW': 'REORDER NOW',
        'SELL_NOW': 'SELL NOW',
        'HOLD_LINE': 'HOLD LINE',
        'DEPRIORITIZE': 'DEPRIORITIZE'
      };
      const actionLabel = actionLabels[decision] || decision;

      // Format money impact - VALIDATED, safe to render
      let moneyDisplay = card.moneyImpact || '';
      if (moneyDisplay && !moneyDisplay.includes('$')) {
        const numericValue = parseFloat(String(moneyDisplay).replace(/[^0-9.-]/g, ''));
        if (!isNaN(numericValue) && isFinite(numericValue)) {
          moneyDisplay = `$${numericValue.toLocaleString()}`;
        } else {
          moneyDisplay = ''; // Suppress invalid money display
        }
      }

      // Use validated name - NO FALLBACK to "Unknown"
      const displayName = card.name || card.sku;
      const displayReason = card.why || card.reason;
      const displayAction = card.whatToDo;

      return `
        <div class="action-card ${cardClass}">
          <div class="action-card-header">
            <span class="action-card-action ${cardClass}">${actionLabel}</span>
            ${timeframeLabel ? `<span class="action-card-timeframe">${timeframeLabel}</span>` : ''}
          </div>
          <div class="action-card-sku">${displayName}</div>
          <div class="action-card-why">${displayReason}</div>
          <div class="action-card-todo">→ ${displayAction}</div>
          ${moneyDisplay ? `
            <div class="action-card-money ${moneyClass}">
              ${moneyDisplay}
            </div>
          ` : ''}
        </div>
      `;
    }

    /**
     * ════════════════════════════════════════════════════════════════════════════
     * RENDER FACT-BASED ACTION
     * ════════════════════════════════════════════════════════════════════════════
     * Actions from split fact layer (SALES_FACTS + INVENTORY_FACTS).
     *
     * HARD GATE: Actions without valid identity are BLOCKED.
     */
    function renderFactBasedAction(action) {
      // ════════════════════════════════════════════════════════════════════════
      // VALIDATION GATE: Block actions without valid name
      // ════════════════════════════════════════════════════════════════════════
      if (!action || !action.name) {
        console.warn('[UI] Blocked action: missing name');
        return '';
      }

      // BLOCK: Names containing 'MISSING' or 'Unknown'
      const nameLower = action.name.toLowerCase();
      if (nameLower.includes('missing') || nameLower.includes('unknown')) {
        console.warn('[UI] Blocked action: invalid name', action.name);
        return '';
      }

      // BLOCK: Actions with NaN in why/impactLabel
      if (action.why && action.why.includes('NaN')) {
        console.warn('[UI] Blocked action: NaN in reason', action.why);
        return '';
      }
      if (action.impactLabel && action.impactLabel.includes('NaN')) {
        console.warn('[UI] Blocked action: NaN in impact', action.impactLabel);
        return '';
      }

      const decision = action.decision || 'DEPRIORITIZE';
      const cardClass = decision.toLowerCase().replace(/_/g, '-');

      const actionLabels = {
        'REORDER_NOW': 'REORDER NOW',
        'SELL_NOW': 'SELL NOW',
        'HOLD_LINE': 'PROTECT MARGIN',
        'DISCOUNT_SLOW': 'DISCOUNT',
        'DEPRIORITIZE': 'MONITOR'
      };
      const actionLabel = actionLabels[decision] || decision.replace(/_/g, ' ');

      const timeframeLabels = {
        'TODAY': 'Today',
        'THIS_WEEK': 'This Week',
        'ONGOING': 'Ongoing',
        'NONE': ''
      };
      const timeframeLabel = timeframeLabels[action.timeframe] || '';

      // Money styling based on decision type
      let moneyClass = 'opportunity';
      if (decision === 'REORDER_NOW') moneyClass = 'at-risk';
      else if (decision === 'HOLD_LINE') moneyClass = 'protect';
      else if (decision === 'DISCOUNT_SLOW') moneyClass = 'opportunity';

      // RECOVERY MODE: Check if action has cost data
      const hasFinancialData = action.hasFinancialData !== false &&
                                action.dollarImpact !== undefined &&
                                action.dollarImpact > 0;

      // Build metrics line from available data (STRICT: only finite values)
      const metrics = action.metrics || {};
      const metricsLine = [];
      if (metrics.quantity !== undefined && metrics.quantity !== null && isFinite(metrics.quantity)) {
        metricsLine.push(`${metrics.quantity} units`);
      }
      if (metrics.velocity !== undefined && metrics.velocity !== null && isFinite(metrics.velocity) && metrics.velocity > 0) {
        metricsLine.push(`${metrics.velocity.toFixed(1)}/day`);
      }
      if (metrics.margin !== undefined && metrics.margin !== null && isFinite(metrics.margin)) {
        metricsLine.push(`${metrics.margin.toFixed(0)}% margin`);
      }
      if (metrics.unitsSold !== undefined && metrics.unitsSold !== null && isFinite(metrics.unitsSold)) {
        metricsLine.push(`${metrics.unitsSold} sold`);
      }
      // STRICT: Only show days since sale if it's a valid finite number
      if (metrics.daysSinceLastSale !== undefined && metrics.daysSinceLastSale !== null && isFinite(metrics.daysSinceLastSale)) {
        metricsLine.push(`${metrics.daysSinceLastSale}d since sale`);
      }

      // Impact label with coverage indicator
      let impactDisplay = '';
      if (hasFinancialData && action.impactLabel) {
        impactDisplay = `
          <div class="action-card-money ${moneyClass}">
            ${action.impactLabel}
          </div>
        `;
      } else if (!hasFinancialData && metrics.quantity) {
        // No cost data - show scoped language
        impactDisplay = `
          <div class="action-card-money" style="color: #ff9800; font-size: 0.85em;">
            ${metrics.quantity} units · cost unavailable
          </div>
        `;
      }

      return `
        <div class="action-card ${cardClass}">
          <div class="action-card-header">
            <span class="action-card-action ${cardClass}">${actionLabel}</span>
            ${timeframeLabel ? `<span class="action-card-timeframe">${timeframeLabel}</span>` : ''}
          </div>
          <div class="action-card-sku">${action.name}</div>
          <div class="action-card-why">${action.why}</div>
          <div class="action-card-todo">→ ${action.whatToDo}</div>
          ${impactDisplay}
          ${metricsLine.length > 0 ? `
            <div style="font-size: 0.75em; color: #666; margin-top: 8px;">
              ${metricsLine.join(' · ')}
            </div>
          ` : ''}
        </div>
      `;
    }

    /**
     * Validate snapshot freshness against inventory sync
     * Snapshot must be generated AFTER inventory sync
     */
    function validateSnapshotFreshness(snapshot) {
      if (!snapshot) return { valid: false, reason: 'No snapshot' };

      const dataFreshness = snapshot.data_freshness;
      if (!dataFreshness) {
        return { valid: false, reason: 'No freshness data' };
      }

      const syncedAt = dataFreshness.inventory_last_synced_at;
      if (!syncedAt) {
        return { valid: false, reason: 'Inventory never synced' };
      }

      const generatedAt = snapshot.generatedAt;
      if (!generatedAt) {
        return { valid: false, reason: 'Snapshot has no timestamp' };
      }

      const syncTime = new Date(syncedAt);
      const genTime = new Date(generatedAt);

      if (genTime < syncTime) {
        return {
          valid: false,
          reason: `Snapshot generated BEFORE inventory sync. Regenerate snapshot.`
        };
      }

      return { valid: true, reason: null };
    }

    // ============================================================================
    // STATUS
    // ============================================================================

    function showStatus(message, type = 'loading') {
      const el = document.getElementById('statusMessage');
      el.textContent = message;
      el.className = `status show ${type}`;
    }

    function hideStatus() {
      document.getElementById('statusMessage').className = 'status';
    }

    // ============================================================================
    // REFUSAL STATE
    // ============================================================================

    function showRefusal(message) {
      document.getElementById('refusalMessage').textContent = message;
      document.getElementById('refusalState').style.display = 'block';
      document.getElementById('snapshotPreview').classList.remove('show');
    }

    function hideRefusal() {
      document.getElementById('refusalState').style.display = 'none';
    }

    // ============================================================================
    // TIMEFRAME HANDLING
    // ============================================================================

    function handleTimeframeChange() {
      const timeframe = document.getElementById('timeframeInput').value;
      const customDateRange = document.getElementById('customDateRange');

      if (timeframe === 'custom') {
        customDateRange.style.display = 'block';
        // Set default dates (last 7 days)
        const today = new Date();
        const weekAgo = new Date(today);
        weekAgo.setDate(weekAgo.getDate() - 7);

        document.getElementById('endDateInput').value = today.toISOString().split('T')[0];
        document.getElementById('startDateInput').value = weekAgo.toISOString().split('T')[0];
      } else {
        customDateRange.style.display = 'none';
      }
    }

    // ============================================================================
    // SNAPSHOT GENERATION
    // ============================================================================

    async function generateSnapshot() {
      try {
        showStatus('Generating snapshot...', 'loading');
        hideRefusal();
        document.getElementById('snapshotPreview').classList.remove('show');

        const timeframe = document.getElementById('timeframeInput').value;

        // Build request body
        const requestBody = { timeframe };

        // Add custom date range if selected
        if (timeframe === 'custom') {
          const startDate = document.getElementById('startDateInput').value;
          const endDate = document.getElementById('endDateInput').value;

          if (!startDate || !endDate) {
            showStatus('Please select start and end dates', 'error');
            return;
          }

          requestBody.startDate = startDate;
          requestBody.endDate = endDate;
        }

        const response = await fetch(`${BACKEND_URL}/snapshot/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });

        const data = await response.json();

        // AUTHORITY ERROR → Show refusal
        if (!data.ok && data.error === 'authority_unavailable') {
          renderConfidence('snapshot', 'low', null);
          renderWarnings('snapshot', data.warnings || [data.message]);
          showRefusal(data.message);
          showStatus('Authority unavailable', 'error');
          return;
        }

        if (!data.ok) {
          throw new Error(data.error || data.message || 'Generation failed');
        }

        const snapshot = data.snapshot;
        if (!snapshot) {
          throw new Error('No snapshot in response');
        }

        currentSnapshot = snapshot;

        // FRESHNESS VALIDATION
        const freshness = validateSnapshotFreshness(snapshot);
        if (!freshness.valid) {
          renderWarnings('snapshot', [freshness.reason, ...(snapshot.warnings || [])]);
        } else {
          renderWarnings('snapshot', snapshot.warnings || []);
        }

        // Render confidence VERBATIM from response
        renderConfidence('snapshot', snapshot.confidence, snapshot.data_freshness);

        // Display snapshot
        displaySnapshot(snapshot);
        showStatus('Snapshot generated', 'success');

      } catch (error) {
        console.error('Snapshot error:', error);
        showStatus(`Error: ${error.message}`, 'error');
        renderConfidence('snapshot', 'low', null);
        renderWarnings('snapshot', [error.message]);
      }
    }

    // ============================================================================
    // SNAPSHOT DISPLAY
    // ============================================================================

    function displaySnapshot(snapshot) {
      if (!snapshot) {
        showRefusal('No snapshot data');
        return;
      }

      const metrics = snapshot.metrics || {};
      const velocity = snapshot.velocity || {};
      const temporal = snapshot.temporal || {};
      const orderContext = snapshot.orderContext || {};
      const actionBrief = snapshot.actionBrief || {};
      const actionBriefActions = actionBrief.actions || [];
      const factLayerStats = actionBrief.factLayerStats || {};
      const briefSummary = actionBrief.summary || {};
      const marginData = actionBrief.marginData || {};

      const hasRealData = temporal.hasRealData === true || velocity.orderCount > 0;
      const timeframeOrders = orderContext.timeframe?.orderCount || velocity.orderCount || 0;
      const last30DaysOrders = orderContext.last30Days?.orderCount || 0;

      // Format timeframe label
      const timeframeLabel = snapshot.timeframe?.charAt(0).toUpperCase() + (snapshot.timeframe?.slice(1) || '');
      const dateRangeStr = snapshot.dateRange ?
        `${new Date(snapshot.dateRange.startDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})} - ${new Date(snapshot.dateRange.endDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}` : '';

      // ═══════════════════════════════════════════════════════════════════════════
      // CALCULATE INVENTORY HEALTH from actionBrief
      // ═══════════════════════════════════════════════════════════════════════════
      const reorderCount = briefSummary.reorderNow || 0;
      const sellNowCount = briefSummary.sellNow || 0;
      const holdLineCount = briefSummary.holdLine || 0;
      const deprioritizeCount = briefSummary.deprioritize || 0;
      const totalClassified = briefSummary.total || (reorderCount + sellNowCount + holdLineCount + deprioritizeCount) || 0;

      // Health calculation: holdLine = healthy, sellNow = slow, reorderNow = critical, deprioritize = dead
      const healthyCount = holdLineCount;
      const slowCount = sellNowCount;
      const criticalCount = reorderCount;
      const deadCount = deprioritizeCount;

      const healthPercent = totalClassified > 0 ? Math.round((healthyCount / totalClassified) * 100) : 0;

      // ═══════════════════════════════════════════════════════════════════════════
      // CALCULATE URGENT STATS from actions
      // ═══════════════════════════════════════════════════════════════════════════
      const urgentItems = actionBriefActions.filter(a => a.decision === 'REORDER_NOW').length;
      const totalRevenueOpportunity = actionBriefActions.reduce((sum, a) => {
        const impact = a.dollarImpact || 0;
        return sum + (isFinite(impact) ? impact : 0);
      }, 0);
      const unitsAtRisk = actionBriefActions.filter(a => a.decision === 'REORDER_NOW').reduce((sum, a) => {
        return sum + (a.metrics?.quantity || 0);
      }, 0);

      console.log('[UI] Mind-blowing UI data:', {
        totalClassified,
        healthPercent,
        urgentItems,
        totalRevenueOpportunity,
        actions: actionBriefActions.length
      });

      let html = '';

      // ═══════════════════════════════════════════════════════════════════════════
      // EXECUTIVE SUMMARY - Key wins, risks, and next actions
      // ═══════════════════════════════════════════════════════════════════════════
      html += `
        <div class="action-brief-headline">
          <div style="font-size:1.1em; margin-bottom:6px;">Executive Summary</div>
          <div style="font-size:1.3em; color:#a78bfa; font-weight:700; margin-bottom:8px;">
            ${marginData.averageMargin && isFinite(marginData.averageMargin) ? `Avg Margin: ${marginData.averageMargin.toFixed(1)}%` : 'Margin: —'}
            ${marginData.coveragePercent !== undefined && marginData.coveragePercent > 0 ? `<span style='font-size:0.8em; color:#888; margin-left:8px;'>(Cost coverage: ${marginData.coveragePercent}%)</span>` : ''}
          </div>
          <div style="margin-bottom:8px; color:#fff;">
            ${marginData.coveragePercent !== undefined && marginData.coveragePercent < 100 && marginData.skusWithSales > 0 ? `
              <span style='color:#fbbf24;'>⚠️ ${marginData.skusWithSales - marginData.skusWithMargin} SKUs/orders missing cost data. Estimated profit opportunity: <b>$${((marginData.skusWithSales - marginData.skusWithMargin) * ((marginData.averageMargin||0)/100) * ((metrics.totalRevenue||0)/(marginData.skusWithSales||1))).toLocaleString(undefined,{maximumFractionDigits:0})}</b> if filled.</span>
            ` : 'All key SKUs have cost data. Margin analytics are robust.'}
          </div>
          <div style="color:#a78bfa; font-size:1em; margin-bottom:4px;">
            ${urgentItems > 0 ? `🔥 <b>${urgentItems}</b> urgent items need action now` : 'No urgent risks detected'}
          </div>
          <div style="color:#4ade80; font-size:1em;">
            ${totalRevenueOpportunity > 0 ? `💰 <b>$${totalRevenueOpportunity.toLocaleString()}</b> revenue opportunity this period` : 'No major revenue at risk'}
          </div>
        </div>
      `;

      // ═══════════════════════════════════════════════════════════════════════════
      // MARGIN/PROFIT TRENDLINE (placeholder for chart)
      // ═══════════════════════════════════════════════════════════════════════════
      html += `
        <div style="background:#232a3a; border-radius:10px; padding:18px 24px; margin-bottom:24px;">
          <div style="font-size:0.95em; color:#a78bfa; margin-bottom:8px;">Margin & Profit Trend</div>
          <div id="trendlineChart" style="height:120px; width:100%; background:#1a1a2a; border-radius:6px;"></div>
        </div>
      `;

      // ═══════════════════════════════════════════════════════════════════════════
      // URGENT ALERT BANNER - The hook
      // ═══════════════════════════════════════════════════════════════════════════
      if (urgentItems > 0 || totalRevenueOpportunity > 0 || actionBriefActions.length > 0) {
        html += `
          <div class="urgent-banner">
            <div class="urgent-stat">
              <div class="urgent-stat-icon">🔥</div>
              <div class="urgent-stat-value" style="color: ${urgentItems > 0 ? '#f87171' : '#4ade80'};">${urgentItems}</div>
              <div class="urgent-stat-label">Need Attention NOW</div>
            </div>
            <div class="urgent-stat">
              <div class="urgent-stat-icon">💰</div>
              <div class="urgent-stat-value" style="color: #fbbf24;">${totalRevenueOpportunity > 0 ? '$' + totalRevenueOpportunity.toLocaleString() : '$0'}</div>
              <div class="urgent-stat-label">Revenue Opportunity</div>
            </div>
            <div class="urgent-stat">
              <div class="urgent-stat-icon">📦</div>
              <div class="urgent-stat-value">${velocity.uniqueSKUs || metrics.totalItems || 0}</div>
              <div class="urgent-stat-label">SKUs Tracked</div>
            </div>
          </div>
        `;
      }

      // ═══════════════════════════════════════════════════════════════════════════
      // PRIORITY ACTIONS - The meat. WHY / DO THIS / OUTCOME format
      // ═══════════════════════════════════════════════════════════════════════════
      if (actionBriefActions.length > 0) {
        html += `<div class="priority-section">`;
        html += `
          <div class="priority-header">
            <div class="priority-title">Priority Actions</div>
            <div class="priority-badge priority-badge-today">${timeframeLabel}</div>
          </div>
        `;

        actionBriefActions.forEach(action => {
          // Skip invalid actions
          if (!action || !action.name) return;
          if (action.name.toLowerCase().includes('missing') || action.name.toLowerCase().includes('unknown')) return;

          // Determine card style
          let cardClass = 'success';
          let badgeClass = 'protect';
          let badgeText = 'PROTECT';
          let outcomeClass = 'protect';
          let outcomeIcon = '🛡️';

          if (action.decision === 'REORDER_NOW') {
            cardClass = 'urgent';
            badgeClass = 'reorder';
            badgeText = 'REORDER NOW';
            outcomeClass = 'risk';
            outcomeIcon = '⚠️';
          } else if (action.decision === 'SELL_NOW' || action.decision === 'DISCOUNT_SLOW') {
            cardClass = 'warning';
            badgeClass = 'promote';
            badgeText = action.decision === 'SELL_NOW' ? 'PROMOTE' : 'DISCOUNT';
            outcomeClass = 'opportunity';
            outcomeIcon = '💰';
          } else if (action.decision === 'DEPRIORITIZE') {
            cardClass = '';
            badgeClass = 'clear';
            badgeText = 'CLEAR';
            outcomeClass = 'opportunity';
            outcomeIcon = '📦';
          }

          // Build outcome text
          let outcomeText = action.impactLabel || '';
          if (!outcomeText && action.dollarImpact && isFinite(action.dollarImpact)) {
            if (action.decision === 'REORDER_NOW') {
              outcomeText = `Prevent $${action.dollarImpact.toLocaleString()} revenue loss`;
            } else {
              outcomeText = `$${action.dollarImpact.toLocaleString()} opportunity`;
            }
          }
          if (!outcomeText && action.metrics?.quantity) {
            outcomeText = `${action.metrics.quantity} units affected`;
          }

          html += `
            <div class="priority-card ${cardClass}">
              <div class="priority-card-badge ${badgeClass}">${badgeText}</div>
              <div class="priority-card-name">${action.name}</div>

              <div class="priority-card-section">
                <div class="priority-card-label">WHY</div>
                <div class="priority-card-value">${action.why || 'Action needed based on inventory analysis'}</div>
              </div>

              <div class="priority-card-section">
                <div class="priority-card-label">DO THIS</div>
                <div class="priority-card-value" style="color: #a78bfa; font-weight: 500;">${action.whatToDo || 'Take action on this item'}</div>
              </div>

              ${outcomeText ? `
                <div class="priority-card-outcome ${outcomeClass}">
                  <span class="priority-card-outcome-icon">${outcomeIcon}</span>
                  <span class="priority-card-outcome-text">${outcomeText}</span>
                </div>
              ` : ''}

              ${action.metrics ? `
                <div style="margin-top: 12px; font-size: 0.8em; color: #666; display: flex; gap: 16px; flex-wrap: wrap;">
                  ${action.metrics.quantity !== undefined && isFinite(action.metrics.quantity) ? `<span>${action.metrics.quantity} units</span>` : ''}
                  ${action.metrics.velocity !== undefined && isFinite(action.metrics.velocity) && action.metrics.velocity > 0 ? `<span>${action.metrics.velocity.toFixed(1)}/day</span>` : ''}
                  ${action.metrics.margin !== undefined && isFinite(action.metrics.margin) ? `<span>${action.metrics.margin.toFixed(0)}% margin</span>` : ''}
                  ${action.metrics.daysSinceLastSale !== undefined && isFinite(action.metrics.daysSinceLastSale) ? `<span>${action.metrics.daysSinceLastSale}d since sale</span>` : ''}
                </div>
              ` : ''}
            </div>
          `;
        });

        html += `</div>`;
      } else {
        // Empty state - but still useful
        html += `
          <div class="empty-actions">
            <div class="empty-actions-icon">✨</div>
            <div class="empty-actions-title">All Systems Healthy</div>
            <div class="empty-actions-text">No urgent actions needed right now. Your inventory is in good shape.</div>
          </div>
        `;
      }

      // ═══════════════════════════════════════════════════════════════════════════
      // INVENTORY HEALTH BAR
      // ═══════════════════════════════════════════════════════════════════════════
      if (totalClassified > 0) {
        const healthyPct = (healthyCount / totalClassified) * 100;
        const slowPct = (slowCount / totalClassified) * 100;
        const criticalPct = (criticalCount / totalClassified) * 100;
        const deadPct = (deadCount / totalClassified) * 100;

        html += `
          <div class="health-section">
            <div class="health-header">
              <div class="health-title">Inventory Health</div>
              <div class="health-percentage">${healthPercent}%</div>
            </div>

            <div class="health-bar-container">
              <div class="health-bar-segment health-bar-healthy" style="width: ${healthyPct}%"></div>
              <div class="health-bar-segment health-bar-slow" style="width: ${slowPct}%"></div>
              <div class="health-bar-segment health-bar-critical" style="width: ${criticalPct}%"></div>
              <div class="health-bar-segment health-bar-dead" style="width: ${deadPct}%"></div>
            </div>

            <div class="health-legend">
              <div class="health-legend-item">
                <div class="health-legend-dot" style="background: #22c55e;"></div>
                <span class="health-legend-count">${healthyCount}</span>
                <span class="health-legend-label">Healthy</span>
              </div>
              <div class="health-legend-item">
                <div class="health-legend-dot" style="background: #f59e0b;"></div>
                <span class="health-legend-count">${slowCount}</span>
                <span class="health-legend-label">Slow</span>
              </div>
              <div class="health-legend-item">
                <div class="health-legend-dot" style="background: #ef4444;"></div>
                <span class="health-legend-count">${criticalCount}</span>
                <span class="health-legend-label">Critical</span>
              </div>
              <div class="health-legend-item">
                <div class="health-legend-dot" style="background: #6b7280;"></div>
                <span class="health-legend-count">${deadCount}</span>
                <span class="health-legend-label">Dead</span>
              </div>
            </div>
          </div>
        `;
      }

      // ═══════════════════════════════════════════════════════════════════════════
      // PERFORMANCE METRICS - This period's numbers
      // ═══════════════════════════════════════════════════════════════════════════
      html += `
        <div class="performance-section">
          <div class="performance-title">${timeframeLabel} Performance ${dateRangeStr ? `<span style="font-weight: 400; color: #666;">(${dateRangeStr})</span>` : ''}</div>

          <div class="performance-grid">
            <div class="performance-stat">
              <div class="performance-stat-value">${timeframeOrders}</div>
              <div class="performance-stat-label">Orders</div>
            </div>
            <div class="performance-stat">
              <div class="performance-stat-value">${velocity.uniqueSKUs || '—'}</div>
              <div class="performance-stat-label">SKUs Sold</div>
            </div>
            <div class="performance-stat">
              <div class="performance-stat-value" style="${
                (marginData.coveragePercent !== undefined && marginData.coveragePercent < 60) ? 'color: #f59e0b; font-weight: 600;' :
                (!marginData.averageMargin && !metrics.averageMargin ? 'font-size: 0.7em; color: #888;' : '')
              }">
                ${
                  // Show margin if any cost data exists, with coverage
                  marginData.averageMargin && isFinite(marginData.averageMargin)
                    ? `${marginData.averageMargin.toFixed(0)}%`
                    : metrics.averageMargin && isFinite(metrics.averageMargin)
                      ? `${metrics.averageMargin.toFixed(0)}%`
                      : 'no cost data'
                }
                ${
                  // Show coverage percent if available
                  marginData.coveragePercent !== undefined && marginData.coveragePercent > 0
                    ? `<span title='${marginData.reason || ''}' style="font-size:0.8em; color:#888; margin-left:6px;">(${marginData.coveragePercent}% cov.)</span>`
                    : ''
                }
                ${
                  // Info icon for tooltip if coverage is partial
                  marginData.coveragePercent !== undefined && marginData.coveragePercent < 100 && marginData.coveragePercent > 0
                    ? `<span title='Margin based on ${marginData.coveragePercent}% of orders with cost data. ${marginData.reason || ''}' style="cursor:help; margin-left:4px; color:#a78bfa;">&#9432;</span>`
                    : ''
                }
              </div>
              <div class="performance-stat-label">Avg Margin</div>
            </div>
          </div>

          ${(orderContext.last30Days?.totalRevenue || orderContext.allTime?.orderCount) ? `
            <div class="performance-insights">
              ${orderContext.last30Days?.totalRevenue ? `
                <div class="performance-insight">
                  <span class="performance-insight-icon">📈</span>
                  <div>
                    <div class="performance-insight-label">Last 30 Days Revenue</div>
                    <div class="performance-insight-value">$${orderContext.last30Days.totalRevenue.toLocaleString()}</div>
                  </div>
                </div>
              ` : ''}
              ${orderContext.allTime?.orderCount ? `
                <div class="performance-insight">
                  <span class="performance-insight-icon">📊</span>
                  <div>
                    <div class="performance-insight-label">All Time Orders</div>
                    <div class="performance-insight-value">${orderContext.allTime.orderCount.toLocaleString()}</div>
                  </div>
                </div>
              ` : ''}
            </div>
          ` : ''}

          <!-- Missed Profit and Missing Cost Data Section -->
          ${marginData && marginData.skusWithSales !== undefined && marginData.skusWithMargin !== undefined && marginData.skusWithMargin < marginData.skusWithSales ? `
            <div class="performance-insights" style="margin-top: 12px;">
              <div class="performance-insight" style="background: #2d1a1a; color: #ff6b6b;">
                <span class="performance-insight-icon">⚠️</span>
                <div>
                  <div class="performance-insight-label">Potential Missed Profit</div>
                  <div class="performance-insight-value">Some SKUs/orders are missing cost data. Fill in cost for these to unlock full profit analytics.</div>
                </div>
              </div>
              ${marginData.topMissingCostSKUs && marginData.topMissingCostSKUs.length > 0 ? `
                <div class="performance-insight" style="background: #232a3a; color: #a78bfa;">
                  <span class="performance-insight-icon">🔍</span>
                  <div>
                    <div class="performance-insight-label">Top SKUs Missing Cost</div>
                    <div class="performance-insight-value">${marginData.topMissingCostSKUs.map(s => s.sku || s).join(', ')}</div>
                  </div>
                </div>
              ` : ''}
            </div>
          ` : ''}
        </div>
      `;

      // ═══════════════════════════════════════════════════════════════════════════
      // FACT LAYER STATS - Small footer for debugging
      // ═══════════════════════════════════════════════════════════════════════════
      const dataStatus = actionBrief.dataStatus || {};
      if (factLayerStats.validFacts !== undefined || factLayerStats.salesFacts !== undefined) {
        // Check for data issues
        let statusMessage = '';
        if (dataStatus.issue === 'INVENTORY_EMPTY') {
          statusMessage = `<span style="color: #ff6b6b;">⚠️ No inventory data - sync inventory first</span>`;
        } else if (dataStatus.issue === 'SKU_MISMATCH') {
          statusMessage = `<span style="color: #ffa500;">${dataStatus.orderCount} orders, but SKUs don't match inventory</span>`;
        } else {
          statusMessage = `<span>Fact Layer: ${factLayerStats.validFacts || factLayerStats.salesFacts || 0} SKUs analyzed</span>`;
        }

        html += `
          <div style="margin-top: 16px; padding: 12px 16px; background: #1a1a2a; border-radius: 8px; font-size: 0.75em; color: #666; display: flex; justify-content: space-between;">
            ${statusMessage}
            <span>${totalClassified} classified · ${factLayerStats.excluded || 0} excluded</span>
          </div>
        `;
      }

      document.getElementById('snapshotContent').innerHTML = html;
      document.getElementById('snapshotPreview').classList.add('show');

      // Render SVG trendline chart (pure vanilla, deterministic)
      (function renderTrendline() {
        const chartEl = document.getElementById('trendlineChart');
        if (!chartEl) return;

        // Use margin/profit trend data if available, else fallback to placeholder
        // Example expected: snapshot.metrics.marginTrend = [{date, margin, profit}, ...]
        const trend = (snapshot.metrics && Array.isArray(snapshot.metrics.marginTrend)) ? snapshot.metrics.marginTrend : null;
        if (!trend || trend.length < 2) {
          chartEl.innerHTML = '<div style="color:#666; text-align:center; width:100%;">Not enough data for trendline</div>';
          return;
        }

        // SVG dimensions
        const W = chartEl.clientWidth || 600;
        const H = chartEl.clientHeight || 120;
        const P = 28; // padding
        const N = trend.length;

        // Extract margin and profit arrays
        const margins = trend.map(pt => typeof pt.margin === 'number' ? pt.margin : 0);
        const profits = trend.map(pt => typeof pt.profit === 'number' ? pt.profit : 0);
        const dates = trend.map(pt => pt.date || '');

        // Y axis scaling
        const minMargin = Math.min(...margins);
        const maxMargin = Math.max(...margins);
        const minProfit = Math.min(...profits);
        const maxProfit = Math.max(...profits);
        // Add some headroom
        const yMargin0 = Math.floor(minMargin - 5);
        const yMargin1 = Math.ceil(maxMargin + 5);
        const yProfit0 = Math.floor(minProfit - 0.1 * Math.abs(minProfit));
        const yProfit1 = Math.ceil(maxProfit + 0.1 * Math.abs(maxProfit));

        // X axis scaling
        const xStep = (W - 2 * P) / (N - 1);

        // Map data to SVG points
        function mapY(val, y0, y1) {
          return H - P - ((val - y0) / (y1 - y0)) * (H - 2 * P);
        }
        function mapX(i) {
          return P + i * xStep;
        }

        // Margin line (purple)
        let marginPath = '';
        margins.forEach((m, i) => {
          const x = mapX(i);
          const y = mapY(m, yMargin0, yMargin1);
          marginPath += (i === 0 ? 'M' : 'L') + x + ',' + y + ' ';
        });

        // Profit line (green)
        let profitPath = '';
        profits.forEach((p, i) => {
          const x = mapX(i);
          const y = mapY(p, yProfit0, yProfit1);
          profitPath += (i === 0 ? 'M' : 'L') + x + ',' + y + ' ';
        });

        // X axis labels (show at most 6 evenly spaced)
        let xLabels = '';
        const labelCount = Math.min(6, N);
        for (let i = 0; i < labelCount; ++i) {
          const idx = Math.round(i * (N - 1) / (labelCount - 1));
          const x = mapX(idx);
          const label = dates[idx] ? String(dates[idx]).slice(5, 10) : '';
          xLabels += `<text x="${x}" y="${H - 4}" fill="#888" font-size="10" text-anchor="middle">${label}</text>`;
        }

        // SVG markup
        chartEl.innerHTML = `
          <svg width="100%" height="100%" viewBox="0 0 ${W} ${H}" style="overflow:visible;">
            <rect x="0" y="0" width="${W}" height="${H}" fill="#1a1a2a" rx="6"/>
            <!-- Margin trend -->
            <polyline points="${margins.map((m,i)=>mapX(i)+','+mapY(m,yMargin0,yMargin1)).join(' ')}" fill="none" stroke="#a78bfa" stroke-width="2.5"/>
            <!-- Profit trend -->
            <polyline points="${profits.map((p,i)=>mapX(i)+','+mapY(p,yProfit0,yProfit1)).join(' ')}" fill="none" stroke="#4ade80" stroke-width="2.5" stroke-dasharray="4 2"/>
            <!-- Axes -->
            <line x1="${P}" y1="${H-P}" x2="${W-P}" y2="${H-P}" stroke="#333" stroke-width="1"/>
            <line x1="${P}" y1="${P}" x2="${P}" y2="${H-P}" stroke="#333" stroke-width="1"/>
            <!-- X labels -->
            ${xLabels}
            <!-- Y axis labels (margin, left) -->
            <text x="6" y="${mapY(yMargin1,yMargin0,yMargin1)+4}" fill="#a78bfa" font-size="10">${yMargin1}%</text>
            <text x="6" y="${mapY(yMargin0,yMargin0,yMargin1)+4}" fill="#a78bfa" font-size="10">${yMargin0}%</text>
            <!-- Y axis labels (profit, right) -->
            <text x="${W-6}" y="${mapY(yProfit1,yProfit0,yProfit1)+4}" fill="#4ade80" font-size="10" text-anchor="end">$${yProfit1}</text>
            <text x="${W-6}" y="${mapY(yProfit0,yProfit0,yProfit1)+4}" fill="#4ade80" font-size="10" text-anchor="end">$${yProfit0}</text>
            <!-- Legends -->
            <rect x="${W-120}" y="${P-18}" width="110" height="18" rx="6" fill="#232a3a"/>
            <circle cx="${W-110}" cy="${P-9}" r="4" fill="#a78bfa"/><text x="${W-100}" y="${P-5}" fill="#a78bfa" font-size="11">Margin</text>
            <circle cx="${W-55}" cy="${P-9}" r="4" fill="#4ade80"/><text x="${W-45}" y="${P-5}" fill="#4ade80" font-size="11">Profit</text>
          </svg>
        `;
      })();
    }

    // ============================================================================
    // CHAT
    // ============================================================================

    let conversationHistory = [];

    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (!message) return;

      addChatMessage('user', message);
      input.value = '';

      const thinkingId = addChatMessage('assistant', 'Thinking...');

      try {
        const response = await fetch(`${BACKEND_URL}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, conversationHistory })
        });

        const data = await response.json();
        document.getElementById(thinkingId).remove();

        // Render confidence and warnings
        renderConfidence('chat', data.confidence, data.data_freshness);
        renderWarnings('chat', data.warnings);

        if (data.response) {
          addChatMessage('assistant', data.response, data.confidence);

          conversationHistory.push(
            { role: 'user', content: message },
            { role: 'assistant', content: data.response }
          );

          if (conversationHistory.length > 20) {
            conversationHistory = conversationHistory.slice(-20);
          }
        } else {
          addChatMessage('assistant', 'Unable to respond.', 'low');
        }
      } catch (error) {
        document.getElementById(thinkingId).remove();
        addChatMessage('assistant', `Error: ${error.message}`, 'low');
        renderWarnings('chat', [error.message]);
      }
    }

    function addChatMessage(role, content, confidence = null) {
      const messagesDiv = document.getElementById('chatMessages');
      const messageId = 'msg-' + Date.now();

      // Clear placeholder
      const placeholder = messagesDiv.querySelector('[style*="Ask OMEN"]');
      if (placeholder) messagesDiv.innerHTML = '';

      const messageDiv = document.createElement('div');
      messageDiv.id = messageId;
      messageDiv.className = `chat-message ${role}`;

      const roleLabel = document.createElement('div');
      roleLabel.className = 'chat-role';
      roleLabel.textContent = role === 'user' ? 'YOU' : 'OMEN';

      const contentDiv = document.createElement('div');
      contentDiv.className = 'chat-content';
      contentDiv.textContent = content;

      messageDiv.appendChild(roleLabel);
      messageDiv.appendChild(contentDiv);

      // Show confidence on assistant messages
      if (role === 'assistant' && confidence) {
        const metaDiv = document.createElement('div');
        metaDiv.className = 'chat-meta';
        metaDiv.textContent = `Confidence: ${confidence.toUpperCase()}`;
        messageDiv.appendChild(metaDiv);
      }

      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      return messageId;
    }

    // ============================================================================
    // NAVIGATION
    // ============================================================================

    function showSection(section) {
      document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.nav a').forEach(el => el.classList.remove('active'));

      if (section === 'chat') {
        document.getElementById('chatSection').classList.add('active');
        document.getElementById('navChat').classList.add('active');
      } else {
        document.getElementById('snapshotSection').classList.add('active');
        document.getElementById('navSnapshot').classList.add('active');
      }
    }

    // ============================================================================
    // INIT
    // ============================================================================
    console.log('OMEN Vault initialized');
  </script>
</body>
</html>
